!function(){"use strict";var t=angular.module("orchestra.project_management.services");t.factory("dataService",["$rootScope","$location","orchestraApi",function(t,n,a){var s,e=new Date;return{setup:function(t){s={tasks:{}},this.projectId=t},updateData:function(s){var e=this;a.projectInformation(this.projectId).then(function(a){e.setData(a.data),"Aborted"===e.data.project.status?(alert("Project is aborted."),n.path("/")):(t.$broadcast("orchestra:projectManagement:dataUpdate"),s&&s())},function(t){var n="Error updating data.";400===t.status&&(n=t.data.message),alert(n)})},setData:function(t){this.data=t;var n={};this.data.steps.forEach(function(t){n[t.slug]=t}),this.data.steps=n;for(var a in this.data.tasks){var s=this.data.tasks[a];s.is_human=this.data.steps[s.step_slug].is_human,s.assignments.forEach(function(t){t.task=s,t.iterations.forEach(function(n,a){n.assignment=t})})}var e=this;this.timeSortedSlugs=Object.keys(this.data.tasks).sort(function(t,n){var a=e.data.tasks[t],s=e.data.tasks[n];return d3.ascending(new Date(a.start_datetime),new Date(s.start_datetime))})},taskFromKey:function(t){return this.data.tasks[t]},keyFromTask:function(t){return t.step_slug},awaitingAssignment:function(t){var n=["Awaiting Processing","Pending Review"];return n.indexOf(t.status)>=0},inProgressAssignment:function(t){var n=["Processing","Post-review Processing","Reviewing"];return n.indexOf(t.status)>=0||this.awaitingAssignment(t)},taskMeta:function(t,n,a){var e=s.tasks[t]||{};return void 0===a?e[n]:(e[n]=a,void(s.tasks[t]=e))},taskEnd:function(t){if(this.awaitingAssignment(t))return e.toString();var n=t.start_datetime;return t.assignments.forEach(function(t){if(t.iterations.length){var a=t.iterations[t.iterations.length-1];new Date(a.end_datetime)>new Date(n)&&(n=a.end_datetime)}}),n},assignmentFromKey:function(t){return this.taskFromKey(t.taskKey).assignments[t.assignmentIndex]},keyFromAssignment:function(t){var n=this;return{taskKey:n.keyFromTask(t.task),assignmentIndex:n.indexFromAssignment(t)}},indexFromAssignment:function(t){return t.task.assignments.indexOf(t)},iterationFromKey:function(t){return this.assignmentFromKey(t.assignmentKey).iterations[t.iterationIndex]},keyFromIteration:function(t){var n=this;return{assignmentKey:n.keyFromAssignment(t.assignment),iterationIndex:t.assignment.iterations.indexOf(t)}}}}])}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hlc3RyYS9wcm9qZWN0X21hbmFnZW1lbnQvanMvZGF0YV9zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbInNlcnZpY2VNb2R1bGUiLCJhbmd1bGFyIiwibW9kdWxlIiwiZmFjdG9yeSIsIiRyb290U2NvcGUiLCIkbG9jYXRpb24iLCJvcmNoZXN0cmFBcGkiLCJfbWV0YSIsIl9ub3ciLCJEYXRlIiwic2V0dXAiLCJwcm9qZWN0SWQiLCJ0YXNrcyIsInRoaXMiLCJ1cGRhdGVEYXRhIiwiY2IiLCJkYXRhU2VydmljZSIsInByb2plY3RJbmZvcm1hdGlvbiIsInRoZW4iLCJyZXNwb25zZSIsInNldERhdGEiLCJkYXRhIiwicHJvamVjdCIsInN0YXR1cyIsImFsZXJ0IiwicGF0aCIsIiRicm9hZGNhc3QiLCJlcnJvck1lc3NhZ2UiLCJtZXNzYWdlIiwic3RlcHMiLCJmb3JFYWNoIiwic3RlcCIsInNsdWciLCJzdGVwX3NsdWciLCJ0YXNrIiwiaXNfaHVtYW4iLCJhc3NpZ25tZW50cyIsImFzc2lnbm1lbnQiLCJpdGVyYXRpb25zIiwiaXRlcmF0aW9uIiwiaSIsInRpbWVTb3J0ZWRTbHVncyIsIk9iamVjdCIsImtleXMiLCJzb3J0IiwiYSIsImIiLCJwcmV2aW91c1Rhc2siLCJuZXh0VGFzayIsImQzIiwiYXNjZW5kaW5nIiwic3RhcnRfZGF0ZXRpbWUiLCJ0YXNrRnJvbUtleSIsImtleSIsImtleUZyb21UYXNrIiwiYXdhaXRpbmdBc3NpZ25tZW50Iiwic3RhdHVzZXMiLCJpbmRleE9mIiwiaW5Qcm9ncmVzc0Fzc2lnbm1lbnQiLCJ0YXNrTWV0YSIsInRhc2tLZXkiLCJtZXRhS2V5IiwidmFsdWUiLCJ1bmRlZmluZWQiLCJ0YXNrRW5kIiwidG9TdHJpbmciLCJsZW5ndGgiLCJsYXN0SXRlcmF0aW9uIiwiZW5kX2RhdGV0aW1lIiwiYXNzaWdubWVudEZyb21LZXkiLCJhc3NpZ25tZW50SW5kZXgiLCJrZXlGcm9tQXNzaWdubWVudCIsImluZGV4RnJvbUFzc2lnbm1lbnQiLCJpdGVyYXRpb25Gcm9tS2V5IiwiYXNzaWdubWVudEtleSIsIml0ZXJhdGlvbkluZGV4Iiwia2V5RnJvbUl0ZXJhdGlvbiJdLCJtYXBwaW5ncyI6IkNBQUEsV0FDRSxZQUVBLElBQUlBLEdBQWdCQyxRQUFRQyxPQUFPLHdDQUVuQ0YsR0FBY0csUUFBUSxlQUFBLGFBQUEsWUFBQSxlQUFlLFNBQVNDLEVBQVlDLEVBQVdDLEdBS25FLEdBQUlDLEdBQ0FDLEVBQU8sR0FBSUMsS0FFZixRQUNFQyxNQUFPLFNBQVNDLEdBQ2RKLEdBQ0VLLFVBRUZDLEtBQUtGLFVBQVlBLEdBRW5CRyxXQUFZLFNBQVNDLEdBSW5CLEdBQUlDLEdBQWNILElBQ2xCUCxHQUFhVyxtQkFBbUJKLEtBQUtGLFdBQ2xDTyxLQUFLLFNBQVNDLEdBQ2JILEVBQVlJLFFBQVFELEVBQVNFLE1BQ1csWUFBcENMLEVBQVlLLEtBQUtDLFFBQVFDLFFBQzNCQyxNQUFNLHVCQUNObkIsRUFBVW9CLEtBQUssT0FFZnJCLEVBQVdzQixXQUFXLDBDQUNsQlgsR0FDRkEsTUFHSCxTQUFTSSxHQUNWLEdBQUlRLEdBQWUsc0JBQ0ssT0FBcEJSLEVBQVNJLFNBQ1hJLEVBQWVSLEVBQVNFLEtBQUtPLFNBRS9CSixNQUFNRyxNQUdaUCxRQUFTLFNBQVNDLEdBSWhCUixLQUFLUSxLQUFPQSxDQUVaLElBQUlRLEtBQ0poQixNQUFLUSxLQUFLUSxNQUFNQyxRQUFRLFNBQVNDLEdBQy9CRixFQUFNRSxFQUFLQyxNQUFRRCxJQUdyQmxCLEtBQUtRLEtBQUtRLE1BQVFBLENBSWxCLEtBQUssR0FBSUksS0FBYXBCLE1BQUtRLEtBQUtULE1BQU8sQ0FDckMsR0FBSXNCLEdBQU9yQixLQUFLUSxLQUFLVCxNQUFNcUIsRUFDM0JDLEdBQUtDLFNBQVd0QixLQUFLUSxLQUFLUSxNQUFNSyxFQUFLRCxXQUFXRSxTQUNoREQsRUFBS0UsWUFBWU4sUUFBUSxTQUFTTyxHQUNoQ0EsRUFBV0gsS0FBT0EsRUFDbEJHLEVBQVdDLFdBQVdSLFFBQVEsU0FBU1MsRUFBV0MsR0FDaERELEVBQVVGLFdBQWFBLE1BSzdCLEdBQUlyQixHQUFjSCxJQUNsQkEsTUFBSzRCLGdCQUFrQkMsT0FBT0MsS0FBSzlCLEtBQUtRLEtBQUtULE9BQU9nQyxLQUFLLFNBQVNDLEVBQUdDLEdBQ25FLEdBQUlDLEdBQWUvQixFQUFZSyxLQUFLVCxNQUFNaUMsR0FDdENHLEVBQVdoQyxFQUFZSyxLQUFLVCxNQUFNa0MsRUFDdEMsT0FBT0csSUFBR0MsVUFBVSxHQUFJekMsTUFBS3NDLEVBQWFJLGdCQUN4QyxHQUFJMUMsTUFBS3VDLEVBQVNHLG9CQUd4QkMsWUFBYSxTQUFTQyxHQUlwQixNQUFPeEMsTUFBS1EsS0FBS1QsTUFBTXlDLElBRXpCQyxZQUFhLFNBQVNwQixHQUlwQixNQUFPQSxHQUFLRCxXQUVkc0IsbUJBQW9CLFNBQVNyQixHQUkzQixHQUFJc0IsSUFBWSxzQkFBdUIsaUJBQ3ZDLE9BQU9BLEdBQVNDLFFBQVF2QixFQUFLWCxTQUFXLEdBRTFDbUMscUJBQXNCLFNBQVN4QixHQUk3QixHQUFJc0IsSUFBWSxhQUFjLHlCQUEwQixZQUN4RCxPQUFPQSxHQUFTQyxRQUFRdkIsRUFBS1gsU0FBVyxHQUFLVixLQUFLMEMsbUJBQW1CckIsSUFFdkV5QixTQUFVLFNBQVNDLEVBQVNDLEVBQVNDLEdBTW5DLEdBQUlILEdBQVdwRCxFQUFNSyxNQUFNZ0QsTUFDM0IsT0FBY0csVUFBVkQsRUFJS0gsRUFBU0UsSUFIaEJGLEVBQVNFLEdBQVdDLE9BQ3BCdkQsRUFBTUssTUFBTWdELEdBQVdELEtBSzNCSyxRQUFTLFNBQVM5QixHQUloQixHQUFJckIsS0FBSzBDLG1CQUFtQnJCLEdBQzFCLE1BQU8xQixHQUFLeUQsVUFFZCxJQUFJRCxHQUFVOUIsRUFBS2lCLGNBU25CLE9BUkFqQixHQUFLRSxZQUFZTixRQUFRLFNBQVNPLEdBQ2hDLEdBQUlBLEVBQVdDLFdBQVc0QixPQUFRLENBQ2hDLEdBQUlDLEdBQWdCOUIsRUFBV0MsV0FBV0QsRUFBV0MsV0FBVzRCLE9BQVMsRUFDckUsSUFBSXpELE1BQUswRCxFQUFjQyxjQUFnQixHQUFJM0QsTUFBS3VELEtBQ2xEQSxFQUFVRyxFQUFjQyxpQkFJdkJKLEdBR1RLLGtCQUFtQixTQUFTaEIsR0FJMUIsTUFBT3hDLE1BQUt1QyxZQUFZQyxFQUFJTyxTQUN6QnhCLFlBQVlpQixFQUFJaUIsa0JBRXJCQyxrQkFBbUIsU0FBU2xDLEdBSTFCLEdBQUlyQixHQUFjSCxJQUNsQixRQUNFK0MsUUFBVzVDLEVBQVlzQyxZQUFZakIsRUFBV0gsTUFDOUNvQyxnQkFBbUJ0RCxFQUFZd0Qsb0JBQW9CbkMsS0FHdkRtQyxvQkFBcUIsU0FBU25DLEdBSTVCLE1BQU9BLEdBQVdILEtBQUtFLFlBQVlxQixRQUFRcEIsSUFHN0NvQyxpQkFBa0IsU0FBU3BCLEdBSXpCLE1BQU94QyxNQUFLd0Qsa0JBQWtCaEIsRUFBSXFCLGVBQWVwQyxXQUFXZSxFQUFJc0IsaUJBRWxFQyxpQkFBa0IsU0FBU3JDLEdBSXpCLEdBQUl2QixHQUFjSCxJQUNsQixRQUNFNkQsY0FBaUIxRCxFQUFZdUQsa0JBQWtCaEMsRUFBVUYsWUFDekRzQyxlQUFrQnBDLEVBQVVGLFdBQVdDLFdBQVdtQixRQUFRbEIiLCJmaWxlIjoib3JjaGVzdHJhL3Byb2plY3RfbWFuYWdlbWVudC9qcy9kYXRhX3NlcnZpY2UubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uKCkge1xuICAndXNlIHN0cmljdCc7XG5cbiAgdmFyIHNlcnZpY2VNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgnb3JjaGVzdHJhLnByb2plY3RfbWFuYWdlbWVudC5zZXJ2aWNlcycpO1xuXG4gIHNlcnZpY2VNb2R1bGUuZmFjdG9yeSgnZGF0YVNlcnZpY2UnLCBmdW5jdGlvbigkcm9vdFNjb3BlLCAkbG9jYXRpb24sIG9yY2hlc3RyYUFwaSkge1xuICAgIC8qKlxuICAgICAqIFNlcnZpY2UgdG8gc2hhcmUgYW5kIG1hbmlwdWxhdGUgcHJvamVjdCBtYW5hZ2VtZW50IGRhdGEgYWNyb3NzXG4gICAgICogdmlzdWFsaXphdGlvbiBjb21wb25lbnRzLlxuICAgICAqL1xuICAgIHZhciBfbWV0YTtcbiAgICB2YXIgX25vdyA9IG5ldyBEYXRlKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc2V0dXA6IGZ1bmN0aW9uKHByb2plY3RJZCkge1xuICAgICAgICBfbWV0YSA9IHtcbiAgICAgICAgICAndGFza3MnOiB7fVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnByb2plY3RJZCA9IHByb2plY3RJZDtcbiAgICAgIH0sXG4gICAgICB1cGRhdGVEYXRhOiBmdW5jdGlvbihjYikge1xuICAgICAgICAvKipcbiAgICAgICAgICogUmV0cmlldmVzIGxhdGVzdCBwcm9qZWN0IGRhdGEgZnJvbSBPcmNoZXN0cmEuXG4gICAgICAgICAqL1xuICAgICAgICB2YXIgZGF0YVNlcnZpY2UgPSB0aGlzO1xuICAgICAgICBvcmNoZXN0cmFBcGkucHJvamVjdEluZm9ybWF0aW9uKHRoaXMucHJvamVjdElkKVxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICBkYXRhU2VydmljZS5zZXREYXRhKHJlc3BvbnNlLmRhdGEpO1xuICAgICAgICAgICAgaWYgKGRhdGFTZXJ2aWNlLmRhdGEucHJvamVjdC5zdGF0dXMgPT09ICdBYm9ydGVkJykge1xuICAgICAgICAgICAgICBhbGVydCgnUHJvamVjdCBpcyBhYm9ydGVkLicpO1xuICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aCgnLycpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCdvcmNoZXN0cmE6cHJvamVjdE1hbmFnZW1lbnQ6ZGF0YVVwZGF0ZScpO1xuICAgICAgICAgICAgICBpZiAoY2IpIHtcbiAgICAgICAgICAgICAgICBjYigpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSwgZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgICAgICAgIHZhciBlcnJvck1lc3NhZ2UgPSAnRXJyb3IgdXBkYXRpbmcgZGF0YS4nO1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDAwKSB7XG4gICAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9IHJlc3BvbnNlLmRhdGEubWVzc2FnZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFsZXJ0KGVycm9yTWVzc2FnZSk7XG4gICAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgc2V0RGF0YTogZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAvKipcbiAgICAgICAgICogUHJlcGFyZXMgcmF3IHByb2plY3QgZGF0YSBmb3IgdmlzdWFsaXphdGlvbi5cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7XG5cbiAgICAgICAgdmFyIHN0ZXBzID0ge307XG4gICAgICAgIHRoaXMuZGF0YS5zdGVwcy5mb3JFYWNoKGZ1bmN0aW9uKHN0ZXApIHtcbiAgICAgICAgICBzdGVwc1tzdGVwLnNsdWddID0gc3RlcDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5kYXRhLnN0ZXBzID0gc3RlcHM7XG5cbiAgICAgICAgIC8qanNoaW50IC1XMDgzICovXG4gICAgICAgIC8vIEhpZGUgZXJyb3IgZm9yIGNyZWF0aW5nIGEgZnVuY3Rpb24gaW4gYSBsb29wXG4gICAgICAgIGZvciAodmFyIHN0ZXBfc2x1ZyBpbiB0aGlzLmRhdGEudGFza3MpIHtcbiAgICAgICAgICB2YXIgdGFzayA9IHRoaXMuZGF0YS50YXNrc1tzdGVwX3NsdWddO1xuICAgICAgICAgIHRhc2suaXNfaHVtYW4gPSB0aGlzLmRhdGEuc3RlcHNbdGFzay5zdGVwX3NsdWddLmlzX2h1bWFuO1xuICAgICAgICAgIHRhc2suYXNzaWdubWVudHMuZm9yRWFjaChmdW5jdGlvbihhc3NpZ25tZW50KSB7XG4gICAgICAgICAgICBhc3NpZ25tZW50LnRhc2sgPSB0YXNrO1xuICAgICAgICAgICAgYXNzaWdubWVudC5pdGVyYXRpb25zLmZvckVhY2goZnVuY3Rpb24oaXRlcmF0aW9uLCBpKSB7XG4gICAgICAgICAgICAgIGl0ZXJhdGlvbi5hc3NpZ25tZW50ID0gYXNzaWdubWVudDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGRhdGFTZXJ2aWNlID0gdGhpcztcbiAgICAgICAgdGhpcy50aW1lU29ydGVkU2x1Z3MgPSBPYmplY3Qua2V5cyh0aGlzLmRhdGEudGFza3MpLnNvcnQoZnVuY3Rpb24oYSwgYikge1xuICAgICAgICAgIHZhciBwcmV2aW91c1Rhc2sgPSBkYXRhU2VydmljZS5kYXRhLnRhc2tzW2FdO1xuICAgICAgICAgIHZhciBuZXh0VGFzayA9IGRhdGFTZXJ2aWNlLmRhdGEudGFza3NbYl07XG4gICAgICAgICAgcmV0dXJuIGQzLmFzY2VuZGluZyhuZXcgRGF0ZShwcmV2aW91c1Rhc2suc3RhcnRfZGF0ZXRpbWUpLFxuICAgICAgICAgICAgbmV3IERhdGUobmV4dFRhc2suc3RhcnRfZGF0ZXRpbWUpKTtcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgdGFza0Zyb21LZXk6IGZ1bmN0aW9uKGtleSkge1xuICAgICAgICAvKipcbiAgICAgICAgICogUmV0dXJucyB0aGUgdGFzayBmb3IgYSBnaXZlbiBrZXkuXG4gICAgICAgICAqL1xuICAgICAgICByZXR1cm4gdGhpcy5kYXRhLnRhc2tzW2tleV07XG4gICAgICB9LFxuICAgICAga2V5RnJvbVRhc2s6IGZ1bmN0aW9uKHRhc2spIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJldHVybnMgdGhlIGtleSBmb3IgYSBnaXZlbiB0YXNrLlxuICAgICAgICAgKi9cbiAgICAgICAgcmV0dXJuIHRhc2suc3RlcF9zbHVnO1xuICAgICAgfSxcbiAgICAgIGF3YWl0aW5nQXNzaWdubWVudDogZnVuY3Rpb24odGFzaykge1xuICAgICAgICAvKipcbiAgICAgICAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIHRhc2sgY2FuIGJlIGdpdmVuIGEgbmV3IGFzc2lnbm1lbnQuXG4gICAgICAgICAqL1xuICAgICAgICB2YXIgc3RhdHVzZXMgPSBbJ0F3YWl0aW5nIFByb2Nlc3NpbmcnLCAnUGVuZGluZyBSZXZpZXcnXTtcbiAgICAgICAgcmV0dXJuIHN0YXR1c2VzLmluZGV4T2YodGFzay5zdGF0dXMpID49IDA7XG4gICAgICB9LFxuICAgICAgaW5Qcm9ncmVzc0Fzc2lnbm1lbnQ6IGZ1bmN0aW9uKHRhc2spIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIERldGVybWluZXMgd2hldGhlciB0YXNrIGhhcyBhIGN1cnJlbnRseS1wcm9jZXNzaW5nIGFzc2lnbm1lbnQuXG4gICAgICAgICAqL1xuICAgICAgICB2YXIgc3RhdHVzZXMgPSBbJ1Byb2Nlc3NpbmcnLCAnUG9zdC1yZXZpZXcgUHJvY2Vzc2luZycsICdSZXZpZXdpbmcnXTtcbiAgICAgICAgcmV0dXJuIHN0YXR1c2VzLmluZGV4T2YodGFzay5zdGF0dXMpID49IDAgfHwgdGhpcy5hd2FpdGluZ0Fzc2lnbm1lbnQodGFzayk7XG4gICAgICB9LFxuICAgICAgdGFza01ldGE6IGZ1bmN0aW9uKHRhc2tLZXksIG1ldGFLZXksIHZhbHVlKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBTdG9yZXMgYW5kIHJlYWRzIGtleWVkIHRhc2sgbWV0YWRhdGEuIFNpbmNlIHdlIHVwZGF0ZSBkYXRhIGZyb20gdGhlXG4gICAgICAgICAqIHNlcnZlciwgd2Ugc3RvcmUgdGFzayB2aXN1YWxpemF0aW9uIGRhdGEgc2VwYXJhdGVseSBzbyBpdCdzIG5vdFxuICAgICAgICAgKiBvdmVyd3JpdHRlbi5cbiAgICAgICAgICovXG4gICAgICAgIHZhciB0YXNrTWV0YSA9IF9tZXRhLnRhc2tzW3Rhc2tLZXldIHx8IHt9O1xuICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHRhc2tNZXRhW21ldGFLZXldID0gdmFsdWU7XG4gICAgICAgICAgX21ldGEudGFza3NbdGFza0tleV0gPSB0YXNrTWV0YTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gdGFza01ldGFbbWV0YUtleV07XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB0YXNrRW5kOiBmdW5jdGlvbih0YXNrKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDYWxjdWxhdGVzIHRoZSBlbmQgdGltZSBmb3IgYSBnaXZlbiB0YXNrLlxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKHRoaXMuYXdhaXRpbmdBc3NpZ25tZW50KHRhc2spKSB7XG4gICAgICAgICAgcmV0dXJuIF9ub3cudG9TdHJpbmcoKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgdGFza0VuZCA9IHRhc2suc3RhcnRfZGF0ZXRpbWU7XG4gICAgICAgIHRhc2suYXNzaWdubWVudHMuZm9yRWFjaChmdW5jdGlvbihhc3NpZ25tZW50KSB7XG4gICAgICAgICAgaWYgKGFzc2lnbm1lbnQuaXRlcmF0aW9ucy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHZhciBsYXN0SXRlcmF0aW9uID0gYXNzaWdubWVudC5pdGVyYXRpb25zW2Fzc2lnbm1lbnQuaXRlcmF0aW9ucy5sZW5ndGggLSAxXTtcbiAgICAgICAgICAgIGlmIChuZXcgRGF0ZShsYXN0SXRlcmF0aW9uLmVuZF9kYXRldGltZSkgPiBuZXcgRGF0ZSh0YXNrRW5kKSkge1xuICAgICAgICAgICAgICB0YXNrRW5kID0gbGFzdEl0ZXJhdGlvbi5lbmRfZGF0ZXRpbWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRhc2tFbmQ7XG4gICAgICB9LFxuXG4gICAgICBhc3NpZ25tZW50RnJvbUtleTogZnVuY3Rpb24oa2V5KSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSZXR1cm5zIHRoZSBhc3NpZ25tZW50IGZvciBhIGdpdmVuIGtleS5cbiAgICAgICAgICovXG4gICAgICAgIHJldHVybiB0aGlzLnRhc2tGcm9tS2V5KGtleS50YXNrS2V5KVxuICAgICAgICAgIC5hc3NpZ25tZW50c1trZXkuYXNzaWdubWVudEluZGV4XTtcbiAgICAgIH0sXG4gICAgICBrZXlGcm9tQXNzaWdubWVudDogZnVuY3Rpb24oYXNzaWdubWVudCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogUmV0dXJucyB0aGUga2V5IGZvciBhIGdpdmVuIGFzc2lnbm1lbnQuXG4gICAgICAgICAqL1xuICAgICAgICB2YXIgZGF0YVNlcnZpY2UgPSB0aGlzO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICd0YXNrS2V5JzogZGF0YVNlcnZpY2Uua2V5RnJvbVRhc2soYXNzaWdubWVudC50YXNrKSxcbiAgICAgICAgICAnYXNzaWdubWVudEluZGV4JzogZGF0YVNlcnZpY2UuaW5kZXhGcm9tQXNzaWdubWVudChhc3NpZ25tZW50KVxuICAgICAgICB9O1xuICAgICAgfSxcbiAgICAgIGluZGV4RnJvbUFzc2lnbm1lbnQ6IGZ1bmN0aW9uKGFzc2lnbm1lbnQpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJldHVybnMgdGhlIGFzc2lnbm1lbnQgY291bnRlciBmb3IgYSBnaXZlbiBhc3NpZ25tZW50LlxuICAgICAgICAgKi9cbiAgICAgICAgcmV0dXJuIGFzc2lnbm1lbnQudGFzay5hc3NpZ25tZW50cy5pbmRleE9mKGFzc2lnbm1lbnQpO1xuICAgICAgfSxcblxuICAgICAgaXRlcmF0aW9uRnJvbUtleTogZnVuY3Rpb24oa2V5KSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSZXR1cm5zIHRoZSBpdGVyYXRpb24gZm9yIHRoZSBnaXZlbiBrZXkuXG4gICAgICAgICAqL1xuICAgICAgICByZXR1cm4gdGhpcy5hc3NpZ25tZW50RnJvbUtleShrZXkuYXNzaWdubWVudEtleSkuaXRlcmF0aW9uc1trZXkuaXRlcmF0aW9uSW5kZXhdO1xuICAgICAgfSxcbiAgICAgIGtleUZyb21JdGVyYXRpb246IGZ1bmN0aW9uKGl0ZXJhdGlvbikge1xuICAgICAgICAvKipcbiAgICAgICAgICogUmV0dXJucyB0aGUga2V5IGZvciBhIGdpdmVuIGl0ZXJhdGlvbi5cbiAgICAgICAgICovXG4gICAgICAgIHZhciBkYXRhU2VydmljZSA9IHRoaXM7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgJ2Fzc2lnbm1lbnRLZXknOiBkYXRhU2VydmljZS5rZXlGcm9tQXNzaWdubWVudChpdGVyYXRpb24uYXNzaWdubWVudCksXG4gICAgICAgICAgJ2l0ZXJhdGlvbkluZGV4JzogaXRlcmF0aW9uLmFzc2lnbm1lbnQuaXRlcmF0aW9ucy5pbmRleE9mKGl0ZXJhdGlvbilcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9O1xuICB9KTtcbn0pKCk7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
