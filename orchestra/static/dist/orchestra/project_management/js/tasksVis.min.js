!function(){"use strict";var t=angular.module("orchestra.project_management.services");t.factory("tasksVis",["$modal","dataService","orchestraApi","visUtils","assignmentsVis","crosshair","axis",function(t,e,a,s,n,r,i){var o=function(t){var e={step:t.task.step_slug,change:t.change,assignments:{}};return t.assignments.forEach(function(t){e.assignments[t.assignment.worker.username]={change:t.change,snapshots:t.snapshots}}),e},l=function(t,e){for(var a,s=0;s<e.length&&!(a=t.classed(e[s]));s++);return a};return{reverting:!1,draw:function(){var t=this,a=s.parentContainer.selectAll(".task-view").data(e.timeSortedSlugs,function(t){return t});a.exit().remove();var r=a.enter().append("div").attr("class","task-view"),o=r.append("svg").attr("class","task-svg").style("margin-left",s.params.marginLeft+"px");a.selectAll(".task-svg").attr("width",s.getSvgWidth()),a.style("width",s.getSvgWidth()+s.params.marginLeft+"px");var c=o.append("g").attr("class","task");a.selectAll(".task").transition().attr({transform:function(t){var a=e.taskFromKey(t);return s.translateString(i.getOffset(a.start_datetime),s.params.lanePadding.top)}}),t.drawRevertFlags(),n.draw();c.append("rect").attr({"class":"task-rect",height:s.params.barHeight,"fill-opacity":0,stroke:"black"});a.selectAll(".task-rect").transition().attr("width",function(t){var a=e.taskFromKey(t);return i.getOffset(e.taskEnd(a))-i.getOffset(a.start_datetime)}).each(function(a){e.taskFromKey(a);t.expand(d3.select(t.parentNode))}),a.on("click",function(a){var s=e.taskFromKey(a),n=d3.select(d3.event.target),r=["task-view","task-svg","task-rect"];if(l(n,r)){s=e.taskFromKey(a);var i=e.taskMeta(a,"expandAssignments");e.taskMeta(a,"expandAssignments",!i),t.distribute()}}),this.drawMeta(),this.drawBackgrounds(),t.distribute()},drawMeta:function(){var t=this,a=d3.select(".task-names").selectAll(".task-name").data(e.timeSortedSlugs,function(t){return t});a.exit().remove();var s=a.enter().append("div").attr("class","task-name");s.append("span").attr("class","step-slug");var n=s.append("div").attr("class","task-action-wrapper"),r=a.selectAll(".task-action-wrapper").selectAll(".skip-task").data(function(t){return"Complete"!=e.taskFromKey(t).status?[t]:[]});r.exit().remove(),r.enter().append("button").attr("class","skip-task task-action btn btn-danger btn-xs").text("Skip task").on("click",function(a){t.completeAndSkipTask(e.taskFromKey(a))}),n.append("a").attr({href:function(t){return e.taskFromKey(t).admin_url},target:"_blank","class":"task-action"}).append("button").attr("class","btn btn-default btn-xs").text("View in admin"),s.append("span").attr("class","step-status"),a.selectAll(".step-slug").text(function(t){var a=e.taskFromKey(t);return a.step_slug}),a.selectAll(".step-status").text(function(t){var a=e.taskFromKey(t);return a.status})},drawBackgrounds:function(){d3.selectAll(".task-name").style("background-color",function(t,e,a){return e%2===0?"#eee":"white"}),s.parentContainer.selectAll(".task-view").style("background-color",function(t,e){return e%2===0?"#eee":"white"})},drawRevertFlags:function(){var t=this,a=s.parentContainer.selectAll(".task"),n=a.selectAll(".revert-group").data(function(t){var a=e.taskFromKey(t),s=[];return a.assignments.forEach(function(t){t.iterations&&t.iterations.forEach(function(t){s.push({datetime:new Date(t.start_datetime),taskKey:a.step_slug})})}),e.inProgressAssignment(a)||s.push({datetime:new Date(e.taskEnd(a)),taskKey:a.step_slug}),s},function(t){return t.datetime});n.exit().remove();var o=n.enter().append("g").attr("class","revert-group");o.append("line").attr({"class":"revert-line",stroke:"rgb(0, 121, 191)"}),o.append("path").attr({d:"M0,0 V4 L-2,2 Z",fill:"rgb(0, 121, 191)",transform:s.translateString(0,-s.params.lanePadding.top/2)+" scale(3, 3)"}).style("cursor","pointer").on("mouseenter",function(e){t.reverting||(r.move(e.datetime),r.show())}).on("mouseleave",function(e){t.reverting||r.hide()}).on("click",function(a){var s=e.taskFromKey(a.taskKey).id;t.revertTask(s,a.datetime)}),n.transition().attr({transform:function(t){var a=e.taskFromKey(t.taskKey).start_datetime;return s.translateString(i.timeScale(t.datetime)-i.getOffset(a),0)}}),n.selectAll(".revert-line").transition().attr({y1:-s.params.lanePadding.top/2,y2:function(t){var a=t.taskKey,n=e.taskFromKey(a);return e.taskMeta(a,"expandAssignments")?(n.assignments.length+1)*s.params.barHeight+1:s.params.barHeight+1}})},expand:function(){var t=d3.selectAll(".task-view");t.selectAll(".assignments").transition().attr("transform",function(t){var a=e.taskMeta(t,"expandAssignments");s.translateString(0,a?s.params.barHeight:0)}),t.selectAll(".assignment").transition().attr({transform:function(t,a){var n=e.assignmentFromKey(t),r=e.keyFromTask(n.task),i=e.taskMeta(r,"expandAssignments");return s.translateString(0,i?s.params.barHeight*(a+1):0)}}),t.selectAll(".assignment-meta").transition().style({position:"absolute",top:function(t,a){var n=e.assignmentFromKey(t),r=e.keyFromTask(n.task),i=e.taskMeta(r,"expandAssignments");return i?s.params.barHeight*(a+1)+s.params.lanePadding.top+4+"px":s.params.lanePadding.top+"px"},right:function(t){var a=e.assignmentFromKey(t);return s.getSvgWidth()-i.getOffset(a.task.start_datetime)+10+"px"},display:function(t,a){var s=e.assignmentFromKey(t),n=e.keyFromTask(s.task),r=e.taskMeta(n,"expandAssignments");return r?"inherit":"none"}}),t.selectAll(".active-assignment").attr("display",function(t){var a=e.assignmentFromKey(t),s=e.keyFromTask(a.task),n=e.taskMeta(s,"expandAssignments");return n?"inherit":"none"})},distribute:function(){s.parentContainer.selectAll(".task-svg").transition().attr({height:function(t){var a=e.taskFromKey(t);return s.getTaskHeight(a)}});var t=d3.selectAll(".task-names").style("margin-top",s.params.scaleHeight+"px");t.selectAll(".task-name").transition().style({height:function(t,a){var n=e.taskFromKey(t);return s.getTaskHeight(n)+"px"},"padding-top":s.params.lanePadding.top/2+"px"});this.drawRevertFlags(),this.expand()},completeAndSkipTask:function(t){confirm("Are you sure you want to skip this task and mark it as complete? This might leave the project in a corrupted/unrecoverable state.")&&a.completeAndSkipTask(t).then(function(){e.updateData()},function(t){var e="Error skipping task.";400===t.status&&(e=t.data.message),alert(e)})},revertTask:function(s,n){var i=this;i.reverting||(i.reverting=!0,a.revertTask(s,n,!0).then(function(l){var c=t.open({templateUrl:"/static/orchestra/project_management/partials/revert_modal.html",controller:["$scope",function(t){t.audit=o(l.data),t.cancel=c.close,t.confirmRevert=function(){a.revertTask(s,n,!1).then(function(){e.updateData()},function(t){var e="Could not revert task.";400===t.status&&(e=t.data.message),alert(e)})["finally"](function(){c.close()})}}]});c.result["finally"](function(){i.reverting=!1,r.hide()})},function(t){var e="Could not generate revert information.";400===t.status&&(e=t.data.message),alert(e)}))}}}])}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hlc3RyYS9wcm9qZWN0X21hbmFnZW1lbnQvanMvdGFza3NWaXMuanMiXSwibmFtZXMiOlsic2VydmljZU1vZHVsZSIsImFuZ3VsYXIiLCJtb2R1bGUiLCJmYWN0b3J5IiwiJG1vZGFsIiwiZGF0YVNlcnZpY2UiLCJvcmNoZXN0cmFBcGkiLCJ2aXNVdGlscyIsImFzc2lnbm1lbnRzVmlzIiwiY3Jvc3NoYWlyIiwiYXhpcyIsIl9odW1hbml6ZUF1ZGl0IiwiYXVkaXQiLCJodW1hbkF1ZGl0Iiwic3RlcCIsInRhc2siLCJzdGVwX3NsdWciLCJjaGFuZ2UiLCJhc3NpZ25tZW50cyIsImZvckVhY2giLCJhc3NpZ25tZW50QXVkaXQiLCJhc3NpZ25tZW50Iiwid29ya2VyIiwidXNlcm5hbWUiLCJzbmFwc2hvdHMiLCJfaGFzT25lQ2xhc3NGcm9tIiwidGFyZ2V0IiwiY2xhc3NlcyIsImNscyIsImkiLCJsZW5ndGgiLCJjbGFzc2VkIiwicmV2ZXJ0aW5nIiwiZHJhdyIsInRhc2tzVmlzIiwidGhpcyIsInRhc2tWaWV3cyIsInBhcmVudENvbnRhaW5lciIsInNlbGVjdEFsbCIsImRhdGEiLCJ0aW1lU29ydGVkU2x1Z3MiLCJzbHVnIiwiZXhpdCIsInJlbW92ZSIsInRhc2tWaWV3c0VudGVyIiwiZW50ZXIiLCJhcHBlbmQiLCJhdHRyIiwidGFza1N2Z3NFbnRlciIsInN0eWxlIiwicGFyYW1zIiwibWFyZ2luTGVmdCIsImdldFN2Z1dpZHRoIiwidGFza3NFbnRlciIsInRyYW5zaXRpb24iLCJ0cmFuc2Zvcm0iLCJ0YXNrS2V5IiwidGFza0Zyb21LZXkiLCJ0cmFuc2xhdGVTdHJpbmciLCJnZXRPZmZzZXQiLCJzdGFydF9kYXRldGltZSIsImxhbmVQYWRkaW5nIiwidG9wIiwiZHJhd1JldmVydEZsYWdzIiwiY2xhc3MiLCJoZWlnaHQiLCJiYXJIZWlnaHQiLCJmaWxsLW9wYWNpdHkiLCJzdHJva2UiLCJ0YXNrRW5kIiwiZWFjaCIsImV4cGFuZCIsImQzIiwic2VsZWN0IiwicGFyZW50Tm9kZSIsIm9uIiwiZXZlbnQiLCJleHBhbmRBc3NpZ25tZW50cyIsInRhc2tNZXRhIiwiZGlzdHJpYnV0ZSIsImRyYXdNZXRhIiwiZHJhd0JhY2tncm91bmRzIiwidGFza05hbWVzIiwidGFza05hbWVzRW50ZXIiLCJ0YXNrQWN0aW9uV3JhcHBlcnMiLCJhY3Rpb25zIiwic3RhdHVzIiwidGV4dCIsImNvbXBsZXRlQW5kU2tpcFRhc2siLCJocmVmIiwiYWRtaW5fdXJsIiwiaiIsInRhc2tzIiwicmV2ZXJ0R3JvdXBzIiwiZGF0ZXRpbWVzIiwiaXRlcmF0aW9ucyIsIml0ZXJhdGlvbiIsInB1c2giLCJkYXRldGltZSIsIkRhdGUiLCJpblByb2dyZXNzQXNzaWdubWVudCIsInJldmVydEdyb3Vwc0VudGVyIiwiZCIsImZpbGwiLCJkYXRldGltZUluZm8iLCJtb3ZlIiwic2hvdyIsImhpZGUiLCJ0YXNrSWQiLCJpZCIsInJldmVydFRhc2siLCJ0YXNrU3RhcnREYXRldGltZSIsInRpbWVTY2FsZSIsInkxIiwieTIiLCJhc3NpZ25tZW50S2V5IiwiYXNzaWdubWVudEZyb21LZXkiLCJrZXlGcm9tVGFzayIsInBvc2l0aW9uIiwicmlnaHQiLCJkaXNwbGF5IiwiZ2V0VGFza0hlaWdodCIsInRhc2tOYW1lc1dyYXBwZXIiLCJzY2FsZUhlaWdodCIsInBhZGRpbmctdG9wIiwiY29uZmlybSIsInRoZW4iLCJ1cGRhdGVEYXRhIiwicmVzcG9uc2UiLCJlcnJvck1lc3NhZ2UiLCJtZXNzYWdlIiwiYWxlcnQiLCJtb2RhbEluc3RhbmNlIiwib3BlbiIsInRlbXBsYXRlVXJsIiwiY29udHJvbGxlciIsIiRzY29wZSIsImNhbmNlbCIsImNsb3NlIiwiY29uZmlybVJldmVydCIsInJlc3VsdCJdLCJtYXBwaW5ncyI6IkNBQUEsV0FDRSxZQUVBLElBQUlBLEdBQWdCQyxRQUFRQyxPQUFPLHdDQUVuQ0YsR0FBY0csUUFBUSxZQUFBLFNBQUEsY0FBQSxlQUFBLFdBQUEsaUJBQUEsWUFBQSxPQUFZLFNB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LEVBQVN6RixLQUFLMkYsU0FFL0JDLE1BQU1GIiwiZmlsZSI6Im9yY2hlc3RyYS9wcm9qZWN0X21hbmFnZW1lbnQvanMvdGFza3NWaXMubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uKCkge1xuICAndXNlIHN0cmljdCc7XG5cbiAgdmFyIHNlcnZpY2VNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgnb3JjaGVzdHJhLnByb2plY3RfbWFuYWdlbWVudC5zZXJ2aWNlcycpO1xuXG4gIHNlcnZpY2VNb2R1bGUuZmFjdG9yeSgndGFza3NWaXMnLCBmdW5jdGlvbigkbW9kYWwsIGRhdGFTZXJ2aWNlLCBvcmNoZXN0cmFBcGksXG4gICAgdmlzVXRpbHMsIGFzc2lnbm1lbnRzVmlzLCBjcm9zc2hhaXIsIGF4aXMpIHtcbiAgICAvKipcbiAgICAgKiBTZXJ2aWNlIHRvIG1vZHVsYXJpemUgdGFzayB2aXN1YWxpemF0aW9uIGFuZCBtYW5pcHVsYXRpb24gd2l0aGluXG4gICAgICogdGhlIHByb2plY3QgbWFuYWdlbWVudCB2aWV3LlxuICAgICAqL1xuICAgIHZhciB0YXNrc1ZpcztcblxuICAgIHZhciBfaHVtYW5pemVBdWRpdCA9IGZ1bmN0aW9uKGF1ZGl0KSB7XG4gICAgICAvKipcbiAgICAgICAqIFNlbGVjdGl2ZWx5IHJlbmRlciBhIHJldmVydCBhdWRpdCBpbiBhIGh1bWFuLXJlYWRhYmxlIHdheS5cbiAgICAgICAqL1xuICAgICAgdmFyIGh1bWFuQXVkaXQgPSB7XG4gICAgICAgICdzdGVwJzogYXVkaXQudGFzay5zdGVwX3NsdWcsXG4gICAgICAgICdjaGFuZ2UnOiBhdWRpdC5jaGFuZ2UsXG4gICAgICAgICdhc3NpZ25tZW50cyc6IHt9LFxuICAgICAgfTtcbiAgICAgIGF1ZGl0LmFzc2lnbm1lbnRzLmZvckVhY2goZnVuY3Rpb24oYXNzaWdubWVudEF1ZGl0KSB7XG4gICAgICAgIGh1bWFuQXVkaXQuYXNzaWdubWVudHNbYXNzaWdubWVudEF1ZGl0LmFzc2lnbm1lbnQud29ya2VyLnVzZXJuYW1lXSA9IHtcbiAgICAgICAgICAnY2hhbmdlJzogYXNzaWdubWVudEF1ZGl0LmNoYW5nZSxcbiAgICAgICAgICAnc25hcHNob3RzJzogYXNzaWdubWVudEF1ZGl0LnNuYXBzaG90c1xuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gaHVtYW5BdWRpdDtcbiAgICB9O1xuXG4gICAgdmFyIF9oYXNPbmVDbGFzc0Zyb20gPSBmdW5jdGlvbih0YXJnZXQsIGNsYXNzZXMpIHtcbiAgICAgIC8qKlxuICAgICAgICogRGV0ZXJtaW5lIGlmIGEgZDMgc2VsZWN0aW9uIGhhcyBhdCBsZWFzdCBvbmUgY2xhc3MgZnJvbSBhIGdpdmVuIGxpc3QuXG4gICAgICAgKi9cbiAgICAgIHZhciBjbHM7XG4gICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNsYXNzZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY2xzID0gdGFyZ2V0LmNsYXNzZWQoY2xhc3Nlc1tpXSk7XG4gICAgICAgIGlmIChjbHMpIHtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIGNscztcbiAgICB9O1xuXG5cbiAgICByZXR1cm4ge1xuICAgICAgcmV2ZXJ0aW5nOiBmYWxzZSxcbiAgICAgIGRyYXc6IGZ1bmN0aW9uKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogRHJhd3MvdXBkYXRlcyB0YXNrcyB3aXRoaW4gcHJvamVjdCBtYW5hZ2VtZW50IHZpc3VhbGl6YXRpb24uXG4gICAgICAgICAqL1xuICAgICAgICB2YXIgdGFza3NWaXMgPSB0aGlzO1xuICAgICAgICB2YXIgdGFza1ZpZXdzID0gdmlzVXRpbHMucGFyZW50Q29udGFpbmVyLnNlbGVjdEFsbCgnLnRhc2stdmlldycpXG4gICAgICAgICAgLmRhdGEoZGF0YVNlcnZpY2UudGltZVNvcnRlZFNsdWdzLCBmdW5jdGlvbihzbHVnKSB7XG4gICAgICAgICAgICByZXR1cm4gc2x1ZztcbiAgICAgICAgICB9KTtcbiAgICAgICAgdGFza1ZpZXdzLmV4aXQoKS5yZW1vdmUoKTtcbiAgICAgICAgdmFyIHRhc2tWaWV3c0VudGVyID0gdGFza1ZpZXdzLmVudGVyKCkuYXBwZW5kKCdkaXYnKVxuICAgICAgICAgIC5hdHRyKCdjbGFzcycsICd0YXNrLXZpZXcnKTtcblxuICAgICAgICB2YXIgdGFza1N2Z3NFbnRlciA9IHRhc2tWaWV3c0VudGVyLmFwcGVuZCgnc3ZnJylcbiAgICAgICAgICAuYXR0cignY2xhc3MnLCAndGFzay1zdmcnKVxuICAgICAgICAgIC5zdHlsZSgnbWFyZ2luLWxlZnQnLCB2aXNVdGlscy5wYXJhbXMubWFyZ2luTGVmdCArICdweCcpO1xuXG4gICAgICAgIHRhc2tWaWV3cy5zZWxlY3RBbGwoJy50YXNrLXN2ZycpLmF0dHIoJ3dpZHRoJywgdmlzVXRpbHMuZ2V0U3ZnV2lkdGgoKSk7XG4gICAgICAgIHRhc2tWaWV3cy5zdHlsZSgnd2lkdGgnLCB2aXNVdGlscy5nZXRTdmdXaWR0aCgpICsgdmlzVXRpbHMucGFyYW1zLm1hcmdpbkxlZnQgKyAncHgnKTtcblxuICAgICAgICB2YXIgdGFza3NFbnRlciA9IHRhc2tTdmdzRW50ZXIuYXBwZW5kKCdnJylcbiAgICAgICAgICAuYXR0cignY2xhc3MnLCAndGFzaycpO1xuXG4gICAgICAgIHRhc2tWaWV3cy5zZWxlY3RBbGwoJy50YXNrJylcbiAgICAgICAgICAudHJhbnNpdGlvbigpXG4gICAgICAgICAgLmF0dHIoe1xuICAgICAgICAgICAgJ3RyYW5zZm9ybSc6IGZ1bmN0aW9uKHRhc2tLZXkpIHtcbiAgICAgICAgICAgICAgdmFyIHRhc2sgPSBkYXRhU2VydmljZS50YXNrRnJvbUtleSh0YXNrS2V5KTtcbiAgICAgICAgICAgICAgcmV0dXJuIHZpc1V0aWxzLnRyYW5zbGF0ZVN0cmluZyhheGlzLmdldE9mZnNldCh0YXNrLnN0YXJ0X2RhdGV0aW1lKSwgdmlzVXRpbHMucGFyYW1zLmxhbmVQYWRkaW5nLnRvcCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgIHRhc2tzVmlzLmRyYXdSZXZlcnRGbGFncygpO1xuXG4gICAgICAgIGFzc2lnbm1lbnRzVmlzLmRyYXcoKTtcblxuICAgICAgICB2YXIgdGFza1JlY3QgPSB0YXNrc0VudGVyLmFwcGVuZCgncmVjdCcpXG4gICAgICAgICAgLmF0dHIoe1xuICAgICAgICAgICAgJ2NsYXNzJzogJ3Rhc2stcmVjdCcsXG4gICAgICAgICAgICAnaGVpZ2h0JzogdmlzVXRpbHMucGFyYW1zLmJhckhlaWdodCxcbiAgICAgICAgICAgICdmaWxsLW9wYWNpdHknOiAwLFxuICAgICAgICAgICAgJ3N0cm9rZSc6ICdibGFjaycsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgdGFza1ZpZXdzLnNlbGVjdEFsbCgnLnRhc2stcmVjdCcpXG4gICAgICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgICAgIC5hdHRyKCd3aWR0aCcsIGZ1bmN0aW9uKHNsdWcpIHtcbiAgICAgICAgICAgIHZhciB0YXNrID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkoc2x1Zyk7XG4gICAgICAgICAgICByZXR1cm4gYXhpcy5nZXRPZmZzZXQoZGF0YVNlcnZpY2UudGFza0VuZCh0YXNrKSkgLSBheGlzLmdldE9mZnNldCh0YXNrLnN0YXJ0X2RhdGV0aW1lKTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5lYWNoKGZ1bmN0aW9uKHNsdWcpIHtcbiAgICAgICAgICAgIHZhciB0YXNrID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkoc2x1Zyk7XG4gICAgICAgICAgICB0YXNrc1Zpcy5leHBhbmQoZDMuc2VsZWN0KHRhc2tzVmlzLnBhcmVudE5vZGUpKTtcbiAgICAgICAgICB9KTtcblxuICAgICAgICB0YXNrVmlld3Mub24oJ2NsaWNrJywgZnVuY3Rpb24odGFza0tleSkge1xuICAgICAgICAgIHZhciB0YXNrID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkodGFza0tleSk7XG4gICAgICAgICAgdmFyIHRhcmdldCA9IGQzLnNlbGVjdChkMy5ldmVudC50YXJnZXQpO1xuICAgICAgICAgIHZhciBjbGFzc2VzID0gWyd0YXNrLXZpZXcnLCAndGFzay1zdmcnLCAndGFzay1yZWN0J107XG4gICAgICAgICAgaWYgKCFfaGFzT25lQ2xhc3NGcm9tKHRhcmdldCwgY2xhc3NlcykpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGFzayA9IGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KHRhc2tLZXkpO1xuICAgICAgICAgIHZhciBleHBhbmRBc3NpZ25tZW50cyA9IGRhdGFTZXJ2aWNlLnRhc2tNZXRhKHRhc2tLZXksICdleHBhbmRBc3NpZ25tZW50cycpO1xuICAgICAgICAgIGRhdGFTZXJ2aWNlLnRhc2tNZXRhKHRhc2tLZXksICdleHBhbmRBc3NpZ25tZW50cycsICFleHBhbmRBc3NpZ25tZW50cyk7XG4gICAgICAgICAgdGFza3NWaXMuZGlzdHJpYnV0ZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmRyYXdNZXRhKCk7XG4gICAgICAgIHRoaXMuZHJhd0JhY2tncm91bmRzKCk7XG4gICAgICAgIHRhc2tzVmlzLmRpc3RyaWJ1dGUoKTtcbiAgICAgIH0sXG4gICAgICBkcmF3TWV0YTogZnVuY3Rpb24oKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBEcmF3cyB0YXNrIHN0ZXAgc2x1Z3MsIHN0YXR1c2VzLCBhbmQgYWN0aW9uIGJ1dHRvbnMgdG8gdGhlIGxlZnQgb2ZcbiAgICAgICAgICogdGhlIG1haW4gcHJvamVjdCBtYW5hZ2VtZW50IHZpc3VhbGl6YXRpb24uXG4gICAgICAgICAqL1xuICAgICAgICB2YXIgdGFza3NWaXMgPSB0aGlzO1xuICAgICAgICB2YXIgdGFza05hbWVzID0gZDMuc2VsZWN0KCcudGFzay1uYW1lcycpLnNlbGVjdEFsbCgnLnRhc2stbmFtZScpXG4gICAgICAgICAgLmRhdGEoZGF0YVNlcnZpY2UudGltZVNvcnRlZFNsdWdzLCBmdW5jdGlvbihzbHVnKSB7XG4gICAgICAgICAgICByZXR1cm4gc2x1ZztcbiAgICAgICAgICB9KTtcbiAgICAgICAgdGFza05hbWVzLmV4aXQoKS5yZW1vdmUoKTtcbiAgICAgICAgdmFyIHRhc2tOYW1lc0VudGVyID0gdGFza05hbWVzLmVudGVyKCkuYXBwZW5kKCdkaXYnKVxuICAgICAgICAgIC5hdHRyKCdjbGFzcycsICd0YXNrLW5hbWUnKTtcbiAgICAgICAgdGFza05hbWVzRW50ZXIuYXBwZW5kKCdzcGFuJylcbiAgICAgICAgICAuYXR0cignY2xhc3MnLCAnc3RlcC1zbHVnJyk7XG4gICAgICAgIHZhciB0YXNrQWN0aW9uV3JhcHBlcnMgPSB0YXNrTmFtZXNFbnRlci5hcHBlbmQoJ2RpdicpLmF0dHIoJ2NsYXNzJywgJ3Rhc2stYWN0aW9uLXdyYXBwZXInKTtcbiAgICAgICAgdmFyIGFjdGlvbnMgPSB0YXNrTmFtZXMuc2VsZWN0QWxsKCcudGFzay1hY3Rpb24td3JhcHBlcicpLnNlbGVjdEFsbCgnLnNraXAtdGFzaycpXG4gICAgICAgICAgLmRhdGEoZnVuY3Rpb24odGFza0tleSkge1xuICAgICAgICAgICAgcmV0dXJuIGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KHRhc2tLZXkpLnN0YXR1cyAhPSAnQ29tcGxldGUnID8gW3Rhc2tLZXldIDogW107XG4gICAgICAgICAgfSk7XG4gICAgICAgIGFjdGlvbnMuZXhpdCgpLnJlbW92ZSgpO1xuICAgICAgICBhY3Rpb25zLmVudGVyKCkuYXBwZW5kKCdidXR0b24nKVxuICAgICAgICAgIC5hdHRyKCdjbGFzcycsICdza2lwLXRhc2sgdGFzay1hY3Rpb24gYnRuIGJ0bi1kYW5nZXIgYnRuLXhzJylcbiAgICAgICAgICAudGV4dCgnU2tpcCB0YXNrJylcbiAgICAgICAgICAub24oJ2NsaWNrJywgZnVuY3Rpb24odGFza0tleSkge1xuICAgICAgICAgICAgdGFza3NWaXMuY29tcGxldGVBbmRTa2lwVGFzayhkYXRhU2VydmljZS50YXNrRnJvbUtleSh0YXNrS2V5KSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIHRhc2tBY3Rpb25XcmFwcGVycy5hcHBlbmQoJ2EnKVxuICAgICAgICAgIC5hdHRyKHtcbiAgICAgICAgICAgICdocmVmJzogZnVuY3Rpb24odGFza0tleSkge1xuICAgICAgICAgICAgICByZXR1cm4gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkodGFza0tleSkuYWRtaW5fdXJsO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICd0YXJnZXQnOiAnX2JsYW5rJyxcbiAgICAgICAgICAgICdjbGFzcyc6ICd0YXNrLWFjdGlvbidcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5hcHBlbmQoJ2J1dHRvbicpXG4gICAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ2J0biBidG4tZGVmYXVsdCBidG4teHMnKVxuICAgICAgICAgIC50ZXh0KCdWaWV3IGluIGFkbWluJyk7XG5cbiAgICAgICAgdGFza05hbWVzRW50ZXIuYXBwZW5kKCdzcGFuJykuYXR0cignY2xhc3MnLCAnc3RlcC1zdGF0dXMnKTtcblxuICAgICAgICB0YXNrTmFtZXMuc2VsZWN0QWxsKCcuc3RlcC1zbHVnJykudGV4dChmdW5jdGlvbihzbHVnKSB7XG4gICAgICAgICAgdmFyIHRhc2sgPSBkYXRhU2VydmljZS50YXNrRnJvbUtleShzbHVnKTtcbiAgICAgICAgICByZXR1cm4gdGFzay5zdGVwX3NsdWc7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRhc2tOYW1lcy5zZWxlY3RBbGwoJy5zdGVwLXN0YXR1cycpLnRleHQoZnVuY3Rpb24oc2x1Zykge1xuICAgICAgICAgIHZhciB0YXNrID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkoc2x1Zyk7XG4gICAgICAgICAgcmV0dXJuIHRhc2suc3RhdHVzO1xuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICBkcmF3QmFja2dyb3VuZHM6IGZ1bmN0aW9uKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogUmVuZGVycyBlYWNoIHRhc2sgXCJzd2ltIGxhbmVcIiB3aXRoIGFuIGFsdGVybmF0aW5nIGNvbG9yLlxuICAgICAgICAgKi9cbiAgICAgICAgZDMuc2VsZWN0QWxsKCcudGFzay1uYW1lJylcbiAgICAgICAgICAuc3R5bGUoJ2JhY2tncm91bmQtY29sb3InLCBmdW5jdGlvbihzbHVnLCBpLCBqKSB7XG4gICAgICAgICAgICByZXR1cm4gaSAlIDIgPT09IDAgPyAnI2VlZScgOiAnd2hpdGUnO1xuICAgICAgICAgIH0pO1xuICAgICAgICB2aXNVdGlscy5wYXJlbnRDb250YWluZXIuc2VsZWN0QWxsKCcudGFzay12aWV3JylcbiAgICAgICAgICAuc3R5bGUoJ2JhY2tncm91bmQtY29sb3InLCBmdW5jdGlvbihzbHVnLCBpKSB7XG4gICAgICAgICAgICByZXR1cm4gaSAlIDIgPT09IDAgPyAnI2VlZScgOiAnd2hpdGUnO1xuICAgICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGRyYXdSZXZlcnRGbGFnczogZnVuY3Rpb24oKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBEcmF3cyB0aGUgZmxhZ3MgY29ycmVzcG9uZGluZyB0byBzdWl0YWJsZSB0YXNrIHJldmVydCB0aW1lcy5cbiAgICAgICAgICovXG4gICAgICAgIHZhciB0YXNrc1ZpcyA9IHRoaXM7XG4gICAgICAgIHZhciB0YXNrcyA9IHZpc1V0aWxzLnBhcmVudENvbnRhaW5lci5zZWxlY3RBbGwoJy50YXNrJyk7XG4gICAgICAgIHZhciByZXZlcnRHcm91cHMgPSB0YXNrcy5zZWxlY3RBbGwoJy5yZXZlcnQtZ3JvdXAnKS5kYXRhKGZ1bmN0aW9uKHNsdWcpIHtcbiAgICAgICAgICB2YXIgdGFzayA9IGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KHNsdWcpO1xuICAgICAgICAgIHZhciBkYXRldGltZXMgPSBbXTtcbiAgICAgICAgICB0YXNrLmFzc2lnbm1lbnRzLmZvckVhY2goZnVuY3Rpb24oYXNzaWdubWVudCkge1xuICAgICAgICAgICAgaWYgKGFzc2lnbm1lbnQuaXRlcmF0aW9ucykge1xuICAgICAgICAgICAgICBhc3NpZ25tZW50Lml0ZXJhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihpdGVyYXRpb24pIHtcbiAgICAgICAgICAgICAgICBkYXRldGltZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAnZGF0ZXRpbWUnOiBuZXcgRGF0ZShpdGVyYXRpb24uc3RhcnRfZGF0ZXRpbWUpLFxuICAgICAgICAgICAgICAgICAgJ3Rhc2tLZXknOiB0YXNrLnN0ZXBfc2x1Z1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgICBpZiAoIWRhdGFTZXJ2aWNlLmluUHJvZ3Jlc3NBc3NpZ25tZW50KHRhc2spKSB7XG4gICAgICAgICAgICBkYXRldGltZXMucHVzaCh7XG4gICAgICAgICAgICAgICdkYXRldGltZSc6IG5ldyBEYXRlKGRhdGFTZXJ2aWNlLnRhc2tFbmQodGFzaykpLFxuICAgICAgICAgICAgICAndGFza0tleSc6IHRhc2suc3RlcF9zbHVnXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGRhdGV0aW1lcztcbiAgICAgICAgfSwgZnVuY3Rpb24oZGF0ZXRpbWUpIHtcbiAgICAgICAgICByZXR1cm4gZGF0ZXRpbWUuZGF0ZXRpbWU7XG4gICAgICAgIH0pO1xuICAgICAgICByZXZlcnRHcm91cHMuZXhpdCgpLnJlbW92ZSgpO1xuICAgICAgICB2YXIgcmV2ZXJ0R3JvdXBzRW50ZXIgPSByZXZlcnRHcm91cHMuZW50ZXIoKS5hcHBlbmQoJ2cnKVxuICAgICAgICAgIC5hdHRyKCdjbGFzcycsICdyZXZlcnQtZ3JvdXAnKTtcblxuICAgICAgICByZXZlcnRHcm91cHNFbnRlci5hcHBlbmQoJ2xpbmUnKVxuICAgICAgICAgIC5hdHRyKHtcbiAgICAgICAgICAgICdjbGFzcyc6ICdyZXZlcnQtbGluZScsXG4gICAgICAgICAgICAnc3Ryb2tlJzogJ3JnYigwLCAxMjEsIDE5MSknLFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFJldmVydCBmbGFnc1xuICAgICAgICByZXZlcnRHcm91cHNFbnRlci5hcHBlbmQoJ3BhdGgnKVxuICAgICAgICAgIC5hdHRyKHtcbiAgICAgICAgICAgICdkJzogJ00wLDAgVjQgTC0yLDIgWicsXG4gICAgICAgICAgICAnZmlsbCc6ICdyZ2IoMCwgMTIxLCAxOTEpJyxcbiAgICAgICAgICAgICd0cmFuc2Zvcm0nOiB2aXNVdGlscy50cmFuc2xhdGVTdHJpbmcoMCwgLXZpc1V0aWxzLnBhcmFtcy5sYW5lUGFkZGluZy50b3AgLyAyKSArICcgc2NhbGUoMywgMyknLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgLnN0eWxlKCdjdXJzb3InLCAncG9pbnRlcicpXG4gICAgICAgICAgLm9uKCdtb3VzZWVudGVyJywgZnVuY3Rpb24oZGF0ZXRpbWVJbmZvKSB7XG4gICAgICAgICAgICBpZiAoIXRhc2tzVmlzLnJldmVydGluZykge1xuICAgICAgICAgICAgICBjcm9zc2hhaXIubW92ZShkYXRldGltZUluZm8uZGF0ZXRpbWUpO1xuICAgICAgICAgICAgICBjcm9zc2hhaXIuc2hvdygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgICAgLm9uKCdtb3VzZWxlYXZlJywgZnVuY3Rpb24oZGF0ZXRpbWVJbmZvKSB7XG4gICAgICAgICAgICBpZiAoIXRhc2tzVmlzLnJldmVydGluZykge1xuICAgICAgICAgICAgICBjcm9zc2hhaXIuaGlkZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgICAgLm9uKCdjbGljaycsIGZ1bmN0aW9uKGRhdGV0aW1lSW5mbykge1xuICAgICAgICAgICAgdmFyIHRhc2tJZCA9IGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KGRhdGV0aW1lSW5mby50YXNrS2V5KS5pZDtcbiAgICAgICAgICAgIHRhc2tzVmlzLnJldmVydFRhc2sodGFza0lkLCBkYXRldGltZUluZm8uZGF0ZXRpbWUpO1xuICAgICAgICAgIH0pO1xuXG4gICAgICAgIHJldmVydEdyb3Vwcy50cmFuc2l0aW9uKCkuYXR0cih7XG4gICAgICAgICAgJ3RyYW5zZm9ybSc6IGZ1bmN0aW9uKGRhdGV0aW1lSW5mbykge1xuICAgICAgICAgICAgdmFyIHRhc2tTdGFydERhdGV0aW1lID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkoZGF0ZXRpbWVJbmZvLnRhc2tLZXkpLnN0YXJ0X2RhdGV0aW1lO1xuICAgICAgICAgICAgcmV0dXJuIHZpc1V0aWxzLnRyYW5zbGF0ZVN0cmluZyhcbiAgICAgICAgICAgICAgYXhpcy50aW1lU2NhbGUoZGF0ZXRpbWVJbmZvLmRhdGV0aW1lKSAtIGF4aXMuZ2V0T2Zmc2V0KHRhc2tTdGFydERhdGV0aW1lKSwgMFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICByZXZlcnRHcm91cHMuc2VsZWN0QWxsKCcucmV2ZXJ0LWxpbmUnKVxuICAgICAgICAgIC50cmFuc2l0aW9uKClcbiAgICAgICAgICAuYXR0cih7XG4gICAgICAgICAgICAneTEnOiAtdmlzVXRpbHMucGFyYW1zLmxhbmVQYWRkaW5nLnRvcCAvIDIsXG4gICAgICAgICAgICAneTInOiBmdW5jdGlvbihkYXRldGltZUluZm8pIHtcbiAgICAgICAgICAgICAgdmFyIHRhc2tLZXkgPSBkYXRldGltZUluZm8udGFza0tleTtcbiAgICAgICAgICAgICAgdmFyIHRhc2sgPSBkYXRhU2VydmljZS50YXNrRnJvbUtleSh0YXNrS2V5KTtcbiAgICAgICAgICAgICAgaWYgKGRhdGFTZXJ2aWNlLnRhc2tNZXRhKHRhc2tLZXksICdleHBhbmRBc3NpZ25tZW50cycpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICh0YXNrLmFzc2lnbm1lbnRzLmxlbmd0aCArIDEpICogdmlzVXRpbHMucGFyYW1zLmJhckhlaWdodCArIDE7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHZpc1V0aWxzLnBhcmFtcy5iYXJIZWlnaHQgKyAxO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGV4cGFuZDogZnVuY3Rpb24oKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBUb2dnbGVzIGV4cGFuc2lvbiBvZiBzZWxlY3RlZCB0YXNrcyB0byBzaG93IG1vcmUgZGV0YWlsZWQgYXNzaWdubWVudFxuICAgICAgICAgKiBkYXRhIGFuZCBhY3Rpb25zLlxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIHRhc2tWaWV3cyA9IGQzLnNlbGVjdEFsbCgnLnRhc2stdmlldycpO1xuXG4gICAgICAgIHRhc2tWaWV3cy5zZWxlY3RBbGwoJy5hc3NpZ25tZW50cycpXG4gICAgICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgICAgIC5hdHRyKCd0cmFuc2Zvcm0nLCBmdW5jdGlvbih0YXNrS2V5KSB7XG4gICAgICAgICAgICB2YXIgZXhwYW5kID0gZGF0YVNlcnZpY2UudGFza01ldGEodGFza0tleSwgJ2V4cGFuZEFzc2lnbm1lbnRzJyk7XG4gICAgICAgICAgICB2aXNVdGlscy50cmFuc2xhdGVTdHJpbmcoMCwgZXhwYW5kID8gdmlzVXRpbHMucGFyYW1zLmJhckhlaWdodCA6IDApO1xuICAgICAgICAgIH0pO1xuXG4gICAgICAgIHRhc2tWaWV3cy5zZWxlY3RBbGwoJy5hc3NpZ25tZW50JylcbiAgICAgICAgICAudHJhbnNpdGlvbigpXG4gICAgICAgICAgLmF0dHIoe1xuICAgICAgICAgICAgJ3RyYW5zZm9ybSc6IGZ1bmN0aW9uKGFzc2lnbm1lbnRLZXksIGkpIHtcbiAgICAgICAgICAgICAgdmFyIGFzc2lnbm1lbnQgPSBkYXRhU2VydmljZS5hc3NpZ25tZW50RnJvbUtleShhc3NpZ25tZW50S2V5KTtcbiAgICAgICAgICAgICAgdmFyIHRhc2tLZXkgPSBkYXRhU2VydmljZS5rZXlGcm9tVGFzayhhc3NpZ25tZW50LnRhc2spO1xuICAgICAgICAgICAgICB2YXIgZXhwYW5kID0gZGF0YVNlcnZpY2UudGFza01ldGEodGFza0tleSwgJ2V4cGFuZEFzc2lnbm1lbnRzJyk7XG4gICAgICAgICAgICAgIHJldHVybiB2aXNVdGlscy50cmFuc2xhdGVTdHJpbmcoMCwgZXhwYW5kID8gKHZpc1V0aWxzLnBhcmFtcy5iYXJIZWlnaHQgKiAoaSArIDEpKSA6IDApO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcblxuICAgICAgICB0YXNrVmlld3Muc2VsZWN0QWxsKCcuYXNzaWdubWVudC1tZXRhJylcbiAgICAgICAgICAudHJhbnNpdGlvbigpXG4gICAgICAgICAgLnN0eWxlKHtcbiAgICAgICAgICAgICdwb3NpdGlvbic6ICdhYnNvbHV0ZScsXG4gICAgICAgICAgICAndG9wJzogZnVuY3Rpb24oYXNzaWdubWVudEtleSwgaSkge1xuICAgICAgICAgICAgICB2YXIgYXNzaWdubWVudCA9IGRhdGFTZXJ2aWNlLmFzc2lnbm1lbnRGcm9tS2V5KGFzc2lnbm1lbnRLZXkpO1xuICAgICAgICAgICAgICB2YXIgdGFza0tleSA9IGRhdGFTZXJ2aWNlLmtleUZyb21UYXNrKGFzc2lnbm1lbnQudGFzayk7XG4gICAgICAgICAgICAgIHZhciBleHBhbmQgPSBkYXRhU2VydmljZS50YXNrTWV0YSh0YXNrS2V5LCAnZXhwYW5kQXNzaWdubWVudHMnKTtcbiAgICAgICAgICAgICAgaWYgKGV4cGFuZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAodmlzVXRpbHMucGFyYW1zLmJhckhlaWdodCAqIChpICsgMSkgKyB2aXNVdGlscy5wYXJhbXMubGFuZVBhZGRpbmcudG9wICsgNCkgKyAncHgnO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJldHVybiB2aXNVdGlscy5wYXJhbXMubGFuZVBhZGRpbmcudG9wICsgJ3B4JztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAncmlnaHQnOiBmdW5jdGlvbihhc3NpZ25tZW50S2V5KSB7XG4gICAgICAgICAgICAgIHZhciBhc3NpZ25tZW50ID0gZGF0YVNlcnZpY2UuYXNzaWdubWVudEZyb21LZXkoYXNzaWdubWVudEtleSk7XG4gICAgICAgICAgICAgIHJldHVybiAodmlzVXRpbHMuZ2V0U3ZnV2lkdGgoKSAtIGF4aXMuZ2V0T2Zmc2V0KGFzc2lnbm1lbnQudGFzay5zdGFydF9kYXRldGltZSkgKyAxMCkgKyAncHgnO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdkaXNwbGF5JzogZnVuY3Rpb24oYXNzaWdubWVudEtleSwgaSkge1xuICAgICAgICAgICAgICB2YXIgYXNzaWdubWVudCA9IGRhdGFTZXJ2aWNlLmFzc2lnbm1lbnRGcm9tS2V5KGFzc2lnbm1lbnRLZXkpO1xuICAgICAgICAgICAgICB2YXIgdGFza0tleSA9IGRhdGFTZXJ2aWNlLmtleUZyb21UYXNrKGFzc2lnbm1lbnQudGFzayk7XG4gICAgICAgICAgICAgIHZhciBleHBhbmQgPSBkYXRhU2VydmljZS50YXNrTWV0YSh0YXNrS2V5LCAnZXhwYW5kQXNzaWdubWVudHMnKTtcbiAgICAgICAgICAgICAgcmV0dXJuIGV4cGFuZCA/ICdpbmhlcml0JyA6ICdub25lJztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgdGFza1ZpZXdzLnNlbGVjdEFsbCgnLmFjdGl2ZS1hc3NpZ25tZW50JylcbiAgICAgICAgICAuYXR0cignZGlzcGxheScsIGZ1bmN0aW9uKGFzc2lnbm1lbnRLZXkpIHtcbiAgICAgICAgICAgIHZhciBhc3NpZ25tZW50ID0gZGF0YVNlcnZpY2UuYXNzaWdubWVudEZyb21LZXkoYXNzaWdubWVudEtleSk7XG4gICAgICAgICAgICB2YXIgdGFza0tleSA9IGRhdGFTZXJ2aWNlLmtleUZyb21UYXNrKGFzc2lnbm1lbnQudGFzayk7XG4gICAgICAgICAgICB2YXIgZXhwYW5kID0gZGF0YVNlcnZpY2UudGFza01ldGEodGFza0tleSwgJ2V4cGFuZEFzc2lnbm1lbnRzJyk7XG4gICAgICAgICAgICByZXR1cm4gZXhwYW5kID8gJ2luaGVyaXQnIDogJ25vbmUnO1xuICAgICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGRpc3RyaWJ1dGU6IGZ1bmN0aW9uKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogVmVydGljYWxseSBkaXN0cmlidXRlIHRhc2sgdmlzdWFsaXphdGlvbnMgaW5zaWRlIHRoZWlyIGNvbnRhaW5lci5cbiAgICAgICAgICovXG4gICAgICAgIHZpc1V0aWxzLnBhcmVudENvbnRhaW5lci5zZWxlY3RBbGwoJy50YXNrLXN2ZycpXG4gICAgICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgICAgIC5hdHRyKHtcbiAgICAgICAgICAgICdoZWlnaHQnOiBmdW5jdGlvbih0YXNrS2V5KSB7XG4gICAgICAgICAgICAgIHZhciB0YXNrID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkodGFza0tleSk7XG4gICAgICAgICAgICAgIHJldHVybiB2aXNVdGlscy5nZXRUYXNrSGVpZ2h0KHRhc2spO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcblxuICAgICAgICB2YXIgdGFza05hbWVzV3JhcHBlciA9IGQzLnNlbGVjdEFsbCgnLnRhc2stbmFtZXMnKS5zdHlsZSgnbWFyZ2luLXRvcCcsIHZpc1V0aWxzLnBhcmFtcy5zY2FsZUhlaWdodCArICdweCcpO1xuICAgICAgICB2YXIgdGFza05hbWVzID0gdGFza05hbWVzV3JhcHBlci5zZWxlY3RBbGwoJy50YXNrLW5hbWUnKVxuICAgICAgICAgIC50cmFuc2l0aW9uKClcbiAgICAgICAgICAuc3R5bGUoe1xuICAgICAgICAgICAgJ2hlaWdodCc6IGZ1bmN0aW9uKHNsdWcsIGkpIHtcbiAgICAgICAgICAgICAgdmFyIHRhc2sgPSBkYXRhU2VydmljZS50YXNrRnJvbUtleShzbHVnKTtcbiAgICAgICAgICAgICAgcmV0dXJuIHZpc1V0aWxzLmdldFRhc2tIZWlnaHQodGFzaykgKyAncHgnO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdwYWRkaW5nLXRvcCc6IHZpc1V0aWxzLnBhcmFtcy5sYW5lUGFkZGluZy50b3AgLyAyICsgJ3B4J1xuICAgICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuZHJhd1JldmVydEZsYWdzKCk7XG4gICAgICAgIHRoaXMuZXhwYW5kKCk7XG4gICAgICB9LFxuICAgICAgY29tcGxldGVBbmRTa2lwVGFzazogZnVuY3Rpb24odGFzaykge1xuICAgICAgICAvKipcbiAgICAgICAgICogSGFuZGxlcyB0aGUgcHJvbWlzZSByZXR1cm5lZCBieSBvcmNoZXN0cmFBcGkuY29tcGxldGVBbmRTa2lwVGFza1xuICAgICAgICAgKiBpbiB0aGUgdmlzdWFsaXphdGlvbi5cbiAgICAgICAgICovXG4gICAgICAgIGlmICghY29uZmlybSgnQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIHNraXAgdGhpcyB0YXNrIGFuZCBtYXJrIGl0ICcgK1xuICAgICAgICAgICdhcyBjb21wbGV0ZT8gVGhpcyBtaWdodCBsZWF2ZSB0aGUgcHJvamVjdCBpbiBhICcgK1xuICAgICAgICAgICdjb3JydXB0ZWQvdW5yZWNvdmVyYWJsZSBzdGF0ZS4nKSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBvcmNoZXN0cmFBcGkuY29tcGxldGVBbmRTa2lwVGFzayh0YXNrKVxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgZGF0YVNlcnZpY2UudXBkYXRlRGF0YSgpO1xuICAgICAgICAgIH0sIGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICB2YXIgZXJyb3JNZXNzYWdlID0gJ0Vycm9yIHNraXBwaW5nIHRhc2suJztcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDQwMCkge1xuICAgICAgICAgICAgICBlcnJvck1lc3NhZ2UgPSByZXNwb25zZS5kYXRhLm1lc3NhZ2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhbGVydChlcnJvck1lc3NhZ2UpO1xuICAgICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIHJldmVydFRhc2s6IGZ1bmN0aW9uKHRhc2tJZCwgZGF0ZXRpbWUpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIERpc3BsYXlzIGEgbW9kYWwgY29udGFpbmluZyB0aGUgYXVkaXQgdHJhaWwgb2YgaXRlbXMgdG8gYmUgcmV2ZXJ0ZWQuXG4gICAgICAgICAqIEhhbmRsZXMgdGhlIHByb21pc2UgcmV0dXJuZWQgYnkgb3JjaGVzdHJhQXBpLnJldmVydFRhc2sgaW4gdGhlXG4gICAgICAgICAqIHZpc3VhbGl6YXRpb24uXG4gICAgICAgICAqL1xuICAgICAgICB2YXIgdGFza3NWaXMgPSB0aGlzO1xuICAgICAgICBpZiAodGFza3NWaXMucmV2ZXJ0aW5nKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRhc2tzVmlzLnJldmVydGluZyA9IHRydWU7XG4gICAgICAgIG9yY2hlc3RyYUFwaS5yZXZlcnRUYXNrKHRhc2tJZCwgZGF0ZXRpbWUsIHRydWUpXG4gICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgICAgICAgIHZhciBtb2RhbEluc3RhbmNlID0gJG1vZGFsLm9wZW4oe1xuICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogJy9zdGF0aWMvb3JjaGVzdHJhL3Byb2plY3RfbWFuYWdlbWVudC9wYXJ0aWFscy9yZXZlcnRfbW9kYWwuaHRtbCcsXG4gICAgICAgICAgICAgIGNvbnRyb2xsZXI6IGZ1bmN0aW9uKCRzY29wZSkge1xuICAgICAgICAgICAgICAgICRzY29wZS5hdWRpdCA9IF9odW1hbml6ZUF1ZGl0KHJlc3BvbnNlLmRhdGEpO1xuICAgICAgICAgICAgICAgICRzY29wZS5jYW5jZWwgPSBtb2RhbEluc3RhbmNlLmNsb3NlO1xuICAgICAgICAgICAgICAgICRzY29wZS5jb25maXJtUmV2ZXJ0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICBvcmNoZXN0cmFBcGkucmV2ZXJ0VGFzayh0YXNrSWQsIGRhdGV0aW1lLCBmYWxzZSlcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgZGF0YVNlcnZpY2UudXBkYXRlRGF0YSgpO1xuICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgICAgICAgIHZhciBlcnJvck1lc3NhZ2UgPSAnQ291bGQgbm90IHJldmVydCB0YXNrLic7XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvck1lc3NhZ2UgPSByZXNwb25zZS5kYXRhLm1lc3NhZ2U7XG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIGFsZXJ0KGVycm9yTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIC5maW5hbGx5KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgIG1vZGFsSW5zdGFuY2UuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG1vZGFsSW5zdGFuY2UucmVzdWx0LmZpbmFsbHkoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgIHRhc2tzVmlzLnJldmVydGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICBjcm9zc2hhaXIuaGlkZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSwgZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgICAgICAgIHZhciBlcnJvck1lc3NhZ2UgPSAnQ291bGQgbm90IGdlbmVyYXRlIHJldmVydCBpbmZvcm1hdGlvbi4nO1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDAwKSB7XG4gICAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9IHJlc3BvbnNlLmRhdGEubWVzc2FnZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFsZXJ0KGVycm9yTWVzc2FnZSk7XG4gICAgICAgICAgfSk7XG4gICAgICB9LFxuICAgIH07XG4gIH0pO1xufSkoKTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
