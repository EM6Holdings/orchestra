!function(){"use strict";function e(e,t){return{restrict:"E",scope:{data:"=",imagePrefix:"=?",readonly:"=",uploadLimitMb:"=?"},link:function(i,r,o){function n(e){if(e.clipboardData&&e.clipboardData.items){var t=e.clipboardData.items[0],r=t.getAsFile();d(r,i.editor.getSelection(),e)}}function a(e){for(var t=e.dataTransfer.files,i=t.length-1;i>=0;i--){var r=t[i],o=l(e);d(r,{start:o,end:o},e)}}function l(e){function t(e,t){var i;if(document.caretPositionFromPoint){var r=document.caretPositionFromPoint(e,t);return{offset:r.offset,node:r.offsetNode}}return document.caretRangeFromPoint?(i=document.caretRangeFromPoint(e,t),{offset:i.startOffset,node:i.startContainer}):void document.body.createTextRange}function r(e){for(var t=[e],i=[];t.length;){var r=t.pop();r.childNodes&&(t=t.concat(Array.prototype.slice.call(r.childNodes))),i.push(r)}return i.reverse()}function o(e){var t=3,i=r(e),o=i.filter(function(e){return e.nodeType===t||!e.firstChild});return o}var n=t(e.clientX,e.clientY);if(!n)return i.editor.getLength();var a=o(c.getElementsByClassName("ql-editor")[0]),l=a.indexOf(n.node),d=i.editor.getContents();return d.ops=d.ops.slice(0,l),d.length()+n.offset}function d(t,r,o){var n="/orchestra/api/interface/upload_image/",a=["image/jpeg","image/png","image/gif"];if(-1===a.indexOf(t.type))return void alert("Files type "+t.type+" not supported.");if(o&&o.preventDefault(),null===r){var l=i.editor.getLength();r={start:l,end:l}}var d=new FileReader;d.onload=function(o){var a=o.target.result,l=a.substring(a.indexOf(",")+1,a.length),d=3*l.length/4;return d>i.uploadLimitMb*Math.pow(10,6)?void alert("Files larger than "+i.uploadLimitMb+"MB cannot be uploaded"):void e.post(n,{image_data:l,image_type:t.type,prefix:i.imagePrefix}).then(function(e,t,o,n){i.editor.deleteText(r),i.editor.insertEmbed(r.start,"image",e.data.url,"user")})},d.readAsDataURL(t)}i.uploadLimitMb=i.uploadLimitMb||5,i.imagePrefix=i.imagePrefix||"";var c=r.find(".orchestra-quill-editor").get(0),s=r.find(".orchestra-quill-toolbar").get(0);if(i.editor=new Quill(c,{modules:{toolbar:{container:s},"link-tooltip":!0},theme:"snow"}),i.$watch("data",function(e,t){i.data&&i.data!=i.editor.getHTML()&&i.editor.setHTML(i.data)}),i.readonly)return i.editor.editor.disable(),void s.remove();i.editor.on("text-change",function(){t(function(){i.data=i.editor.getHTML(),i.$apply()},0,!1)}),i.fileSelector=document.createElement("input"),i.fileSelector.setAttribute("type","file"),i.fileSelector.setAttribute("accept","image/*");var u=r.find(".orchestra-quill-toolbar .ql-image").get(0);i.fileSelector.onchange=function(e){i.editor.focus();for(var t=i.fileSelector.files,r=t.length-1;r>=0;r--)null!==t[r]&&d(t[r],i.editor.getSelection())},u.onclick=function(){return i.fileSelector.click(),!1},c.addEventListener("paste",n,!0),c.addEventListener("drop",a,!0)},templateUrl:"/static/orchestra/common/components/quill/partials/quill.html"}}angular.module("orchestra.common.components.directives").directive("orchestraQuill",["$http","$timeout",e])}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hlc3RyYS9jb21tb24vY29tcG9uZW50cy9xdWlsbC9qcy9kaXJlY3RpdmVzLmpzIl0sIm5hbWVzIjpbIm9yY2hlc3RyYVF1aWxsIiwiJGh0dHAiLCIkdGltZW91dCIsInJlc3RyaWN0Iiwic2NvcGUiLCJkYXRhIiwiaW1hZ2VQcmVmaXgiLCJyZWFkb25seSIsInVwbG9hZExpbWl0TWIiLCJsaW5rIiwiZWwiLCJhdHRyIiwicGFzdGVJbWFnZSIsImUiLCJjbGlwYm9hcmREYXRhIiwiaXRlbXMiLCJjb3BpZWREYXRhIiwiaW1hZ2VGaWxlIiwiZ2V0QXNGaWxlIiwidXBsb2FkSW1hZ2UiLCJlZGl0b3IiLCJnZXRTZWxlY3Rpb24iLCJkcm9wSW1hZ2UiLCJmaWxlcyIsImRhdGFUcmFuc2ZlciIsImkiLCJsZW5ndGgiLCJmaWxlIiwiZHJvcE9mZnNldCIsImdldERyb3BJbmRleE9mZnNldCIsInN0YXJ0IiwiZW5kIiwiZHJvcEV2ZW50IiwiZ2V0RHJvcENoYXJPZmZzZXQiLCJ4IiwieSIsInJhbmdlIiwiZG9jdW1lbnQiLCJjYXJldFBvc2l0aW9uRnJvbVBvaW50IiwicG9zIiwib2Zmc2V0Iiwibm9kZSIsIm9mZnNldE5vZGUiLCJjYXJldFJhbmdlRnJvbVBvaW50Iiwic3RhcnRPZmZzZXQiLCJzdGFydENvbnRhaW5lciIsImJvZHkiLCJjcmVhdGVUZXh0UmFuZ2UiLCJnZXRBbGxDaGlsZE5vZGVzIiwicGFyZW50IiwiYmZzU3RhY2siLCJub2RlcyIsImN1cnJlbnROb2RlIiwicG9wIiwiY2hpbGROb2RlcyIsImNvbmNhdCIsIkFycmF5IiwicHJvdG90eXBlIiwic2xpY2UiLCJjYWxsIiwicHVzaCIsInJldmVyc2UiLCJnZXRMZWFmTm9kZXMiLCJ0ZXh0Tm9kZVR5cGUiLCJsZWFmTm9kZXMiLCJmaWx0ZXIiLCJlbGVtIiwibm9kZVR5cGUiLCJmaXJzdENoaWxkIiwiY2FyZXRQb3NpdGlvbiIsImNsaWVudFgiLCJjbGllbnRZIiwiZ2V0TGVuZ3RoIiwibGVhdmVzIiwiZWRpdG9yQ29udGFpbmVyIiwiZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSIsIm9wSW5kZXgiLCJpbmRleE9mIiwiY29udGVudHMiLCJnZXRDb250ZW50cyIsIm9wcyIsInVwbG9hZEFQSUVuZHBvaW50Iiwic3VwcG9ydGVkVHlwZXMiLCJ0eXBlIiwiYWxlcnQiLCJwcmV2ZW50RGVmYXVsdCIsImVuZEluZGV4IiwicmVhZGVyIiwiRmlsZVJlYWRlciIsIm9ubG9hZCIsInJhd0RhdGEiLCJ0YXJnZXQiLCJyZXN1bHQiLCJpbWFnZURhdGEiLCJzdWJzdHJpbmciLCJpbWFnZVNpemUiLCJNYXRoIiwicG93IiwicG9zdCIsImltYWdlX2RhdGEiLCJpbWFnZV90eXBlIiwicHJlZml4IiwidGhlbiIsInJlc3BvbnNlIiwic3RhdHVzIiwiaGVhZGVycyIsImNvbmZpZyIsImRlbGV0ZVRleHQiLCJpbnNlcnRFbWJlZCIsInVybCIsInJlYWRBc0RhdGFVUkwiLCJmaW5kIiwiZ2V0IiwidG9vbGJhckNvbnRhaW5lciIsIlF1aWxsIiwibW9kdWxlcyIsInRvb2xiYXIiLCJjb250YWluZXIiLCJsaW5rLXRvb2x0aXAiLCJ0aGVtZSIsIiR3YXRjaCIsIm5vdyIsImJlZm9yZSIsImdldEhUTUwiLCJzZXRIVE1MIiwiZGlzYWJsZSIsInJlbW92ZSIsIm9uIiwiJGFwcGx5IiwiZmlsZVNlbGVjdG9yIiwiY3JlYXRlRWxlbWVudCIsInNldEF0dHJpYnV0ZSIsImltYWdlU2VsZWN0b3IiLCJvbmNoYW5nZSIsImZvY3VzIiwib25jbGljayIsImNsaWNrIiwiYWRkRXZlbnRMaXN0ZW5lciIsInRlbXBsYXRlVXJsIiwiYW5ndWxhciIsIm1vZHVsZSIsImRpcmVjdGl2ZSJdLCJtYXBwaW5ncyI6IkNBQUEsV0FDRSxZQU1BLFNBQVNBLEdBQWVDLEVBQU9DLEdBQzdCLE9BQ0VDLFNBQVUsSUFDVkMsT0FDRUMsS0FBUSxJQUNSQyxZQUFlLEtBQ2ZDLFNBQVksSUFDWkMsY0FBaUIsTUFFbkJDLEtBQU0sU0FBU0wsRUFBT00sRUFB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LE1BQ3RCRSxFQUFJRixFQUFNRyxPQUFTLEVBQUdELEdBQUssRUFBR0EsSUFDcEIsT0FBYkYsRUFBTUUsSUFDUk4sRUFBWUksRUFBTUUsR0FBSXJCLEVBQU1nQixPQUFPQyxpQkFJekMrRyxFQUFjRyxRQUFVLFdBRXRCLE1BREFuSSxHQUFNNkgsYUFBYU8sU0FDWixHQU1UOUQsRUFBZ0IrRCxpQkFBaUIsUUFBUzdILEdBQVksR0FXdEQ4RCxFQUFnQitELGlCQUFpQixPQUFRbkgsR0FBVyxJQTRJdERvSCxZQUFhLGlFQTFPakJDLFFBQ0dDLE9BQU8sMENBQ1BDLFVBQVUsa0JBQW1CLFFBQVMsV0FBWTdJIiwiZmlsZSI6Im9yY2hlc3RyYS9jb21tb24vY29tcG9uZW50cy9xdWlsbC9qcy9kaXJlY3RpdmVzLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIGFuZ3VsYXJcbiAgICAubW9kdWxlKCdvcmNoZXN0cmEuY29tbW9uLmNvbXBvbmVudHMuZGlyZWN0aXZlcycpXG4gICAgLmRpcmVjdGl2ZSgnb3JjaGVzdHJhUXVpbGwnLCBbJyRodHRwJywgJyR0aW1lb3V0Jywgb3JjaGVzdHJhUXVpbGxdKTtcblxuICBmdW5jdGlvbiBvcmNoZXN0cmFRdWlsbCgkaHR0cCwgJHRpbWVvdXQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgcmVzdHJpY3Q6ICdFJyxcbiAgICAgIHNjb3BlOiB7XG4gICAgICAgICdkYXRhJzogJz0nLFxuICAgICAgICAnaW1hZ2VQcmVmaXgnOiAnPT8nLFxuICAgICAgICAncmVhZG9ubHknOiAnPScsXG4gICAgICAgICd1cGxvYWRMaW1pdE1iJzogJz0/JyxcbiAgICAgIH0sXG4gICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWwsIGF0dHIpIHtcbiAgICAgICAgLy8gU3VnZ2VzdGVkIGxpbWl0IGZvciBpbWFnZSB1cGxvYWQgc2l6ZSBpcyA1IE1CLlxuICAgICAgICBzY29wZS51cGxvYWRMaW1pdE1iID0gc2NvcGUudXBsb2FkTGltaXRNYiB8fCA1O1xuXG4gICAgICAgIC8vIERlZmF1bHQgaW1hZ2UgcHJlZml4IGlzIGFuIGVtcHR5IHN0cmluZy5cbiAgICAgICAgc2NvcGUuaW1hZ2VQcmVmaXggPSBzY29wZS5pbWFnZVByZWZpeCB8fCAnJztcblxuICAgICAgICAvLyBDb250YWluZXJzIHdpdGhpbiBkaXJlY3RpdmUgdGVtcGxhdGUgZm9yIFF1aWxsIGVkaXRvclxuICAgICAgICB2YXIgZWRpdG9yQ29udGFpbmVyID0gZWwuZmluZCgnLm9yY2hlc3RyYS1xdWlsbC1lZGl0b3InKS5nZXQoMCk7XG4gICAgICAgIHZhciB0b29sYmFyQ29udGFpbmVyID0gZWwuZmluZCgnLm9yY2hlc3RyYS1xdWlsbC10b29sYmFyJykuZ2V0KDApO1xuXG4gICAgICAgIHNjb3BlLmVkaXRvciA9IG5ldyBRdWlsbChlZGl0b3JDb250YWluZXIsIHtcbiAgICAgICAgICBtb2R1bGVzOiB7XG4gICAgICAgICAgICAndG9vbGJhcic6IHtcbiAgICAgICAgICAgICAgY29udGFpbmVyOiB0b29sYmFyQ29udGFpbmVyXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLy8gSW1hZ2UgdG9vbHRpcCByZW1vdmVkIGluIGZhdm9yIG9mIGZpbGUgc2VsZWN0b3IgZGlhbG9nXG4gICAgICAgICAgICAnbGluay10b29sdGlwJzogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRoZW1lOiAnc25vdydcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gU2V0IHVwIHR3by13YXkgbGluayBiZXR3ZWVuIHF1aWxsIGFuZCBwYXJlbnQgc2NvcGUgYXR0cmlidXRlIHBhc3NlZFxuICAgICAgICAvLyBpbiBieSBkaXJlY3RpdmUgY2FsbGVyXG4gICAgICAgIHNjb3BlLiR3YXRjaCgnZGF0YScsIGZ1bmN0aW9uKG5vdywgYmVmb3JlKSB7XG4gICAgICAgICAgaWYgKHNjb3BlLmRhdGEgJiYgc2NvcGUuZGF0YSAhPSBzY29wZS5lZGl0b3IuZ2V0SFRNTCgpKSB7XG4gICAgICAgICAgICBzY29wZS5lZGl0b3Iuc2V0SFRNTChzY29wZS5kYXRhKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG5cbiAgICAgICAgLy8gRWRpdG9yIHNldCB0byByZWFkLW9ubHkgdXBvbiBpbml0aWFsaXphdGlvbi5cbiAgICAgICAgaWYgKHNjb3BlLnJlYWRvbmx5KSB7XG4gICAgICAgICAgc2NvcGUuZWRpdG9yLmVkaXRvci5kaXNhYmxlKCk7XG4gICAgICAgICAgdG9vbGJhckNvbnRhaW5lci5yZW1vdmUoKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBzY29wZS5lZGl0b3Iub24oJ3RleHQtY2hhbmdlJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgLy8gU2V0IHRoZSBmb2N1cyBvdXRzaWRlIHRoZSAkZGlnZXN0IGJsb2NrLlxuICAgICAgICAgIC8vIFRha2VuIGZyb20gaHR0cHM6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvZXJyb3IvJHJvb3RTY29wZS9pbnByb2c/cDA9JGRpZ2VzdC5cbiAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHNjb3BlLmRhdGEgPSBzY29wZS5lZGl0b3IuZ2V0SFRNTCgpO1xuICAgICAgICAgICAgc2NvcGUuJGFwcGx5KCk7XG4gICAgICAgICAgfSwgMCwgZmFsc2UpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBVcGxvYWQgaW1hZ2UgdmlhIHRoZSB0b29sYmFyIGJ1dHRvblxuICAgICAgICBzY29wZS5maWxlU2VsZWN0b3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpO1xuICAgICAgICBzY29wZS5maWxlU2VsZWN0b3Iuc2V0QXR0cmlidXRlKCd0eXBlJywgJ2ZpbGUnKTtcbiAgICAgICAgc2NvcGUuZmlsZVNlbGVjdG9yLnNldEF0dHJpYnV0ZSgnYWNjZXB0JywgJ2ltYWdlLyonKTtcbiAgICAgICAgdmFyIGltYWdlU2VsZWN0b3IgPSBlbC5maW5kKCcub3JjaGVzdHJhLXF1aWxsLXRvb2xiYXIgLnFsLWltYWdlJykuZ2V0KDApO1xuICAgICAgICBzY29wZS5maWxlU2VsZWN0b3Iub25jaGFuZ2UgPSBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgLy8gRm9jdXMgdGhlIGVkaXRvciBzbyB3ZSBjYW4gZ2V0IHRoZSBjdXJyZW50IHNlbGVjdGlvbi5cbiAgICAgICAgICBzY29wZS5lZGl0b3IuZm9jdXMoKTtcbiAgICAgICAgICB2YXIgZmlsZXMgPSBzY29wZS5maWxlU2VsZWN0b3IuZmlsZXM7XG4gICAgICAgICAgZm9yICh2YXIgaSA9IGZpbGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgICAgICBpZiAoZmlsZXNbaV0gIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgdXBsb2FkSW1hZ2UoZmlsZXNbaV0sIHNjb3BlLmVkaXRvci5nZXRTZWxlY3Rpb24oKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBpbWFnZVNlbGVjdG9yLm9uY2xpY2sgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICBzY29wZS5maWxlU2VsZWN0b3IuY2xpY2soKTtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gVE9ETyhqcmJvdHJvcyk6IG1vdmUgcGFzdGUvZHJvcCBmdW5jdGlvbmFsaXR5IGludG8gYSBxdWlsbGpzIGZvcmtcblxuICAgICAgICAvLyBVcGxvYWQgaW1hZ2UgYnkgcGFzdGluZyBpbiBjb3BpZWQgaW1hZ2UgZGF0YVxuICAgICAgICBlZGl0b3JDb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigncGFzdGUnLCBwYXN0ZUltYWdlLCB0cnVlKTtcblxuICAgICAgICBmdW5jdGlvbiBwYXN0ZUltYWdlKGUpIHtcbiAgICAgICAgICBpZiAoZS5jbGlwYm9hcmREYXRhICYmIGUuY2xpcGJvYXJkRGF0YS5pdGVtcykge1xuICAgICAgICAgICAgdmFyIGNvcGllZERhdGEgPSBlLmNsaXBib2FyZERhdGEuaXRlbXNbMF07XG4gICAgICAgICAgICB2YXIgaW1hZ2VGaWxlID0gY29waWVkRGF0YS5nZXRBc0ZpbGUoKTtcbiAgICAgICAgICAgIHVwbG9hZEltYWdlKGltYWdlRmlsZSwgc2NvcGUuZWRpdG9yLmdldFNlbGVjdGlvbigpLCBlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBVcGxvYWQgaW1hZ2UgYnkgZHJhZyBhbmQgZHJvcFxuICAgICAgICBlZGl0b3JDb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignZHJvcCcsIGRyb3BJbWFnZSwgdHJ1ZSk7XG5cbiAgICAgICAgZnVuY3Rpb24gZHJvcEltYWdlKGUpIHtcbiAgICAgICAgICB2YXIgZmlsZXMgPSBlLmRhdGFUcmFuc2Zlci5maWxlcztcbiAgICAgICAgICBmb3IgKHZhciBpID0gZmlsZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgIHZhciBmaWxlID0gZmlsZXNbaV07XG4gICAgICAgICAgICB2YXIgZHJvcE9mZnNldCA9IGdldERyb3BJbmRleE9mZnNldChlKTtcbiAgICAgICAgICAgIHVwbG9hZEltYWdlKGZpbGUsIHtcbiAgICAgICAgICAgICAgJ3N0YXJ0JzogZHJvcE9mZnNldCxcbiAgICAgICAgICAgICAgJ2VuZCc6IGRyb3BPZmZzZXRcbiAgICAgICAgICAgIH0sIGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGdldERyb3BJbmRleE9mZnNldChkcm9wRXZlbnQpIHtcbiAgICAgICAgICAvKipcbiAgICAgICAgICAgKiBHaXZlbiBhIGRyb3AgZXZlbnQsIGNhbGN1bGF0ZSB0aGUgaW5kZXggb2Zmc2V0IHdpdGhpbiB0aGVcbiAgICAgICAgICAgKiBRdWlsbCBlZGl0b3IgYnk6XG4gICAgICAgICAgICogICAtIGRldGVybWluaW5nIHRoZSBjaGFyYWN0ZXIgb2Zmc2V0IG9mIHRoZSBkcm9wIHdpdGhpbiB0aGUgaW5uZXIgbm9kZVxuICAgICAgICAgICAqICAgLSBmaW5kaW5nIGFsbCBlZGl0b3IgbGVhZiBub2RlcyAocmVpbXBsZW1lbnRzIHNvbWUgUXVpbGwgZnVuY3Rpb25hbGl0eSlcbiAgICAgICAgICAgKiAgIC0gY2FsY3VsYXRpbmcgdGhlIGluZGV4IG9mZnNldCBmcm9tIHRoZSBsZWFmIG5vZGUgbGVuZ3RocyBhbmQgaW5uZXIgZHJvcCBub2RlIG9mZnNldFxuICAgICAgICAgICAqIFdlIHBsYW4gdG8gcHVzaCB0aGlzIGZ1bmN0aW9uYWxpdHkgaW50byBRdWlsbCBpbiB0aGUgZnV0dXJlLlxuICAgICAgICAgICAqL1xuICAgICAgICAgIGZ1bmN0aW9uIGdldERyb3BDaGFyT2Zmc2V0KHgsIHkpIHtcbiAgICAgICAgICAgIC8vIEhlbHBlciBmdW5jdGlvbiBmb3IgZ2V0dGluZyB0aGUgeC15IGNoYXJhY3RlciBvZmZzZXQgb2YgYSBkcm9wXG4gICAgICAgICAgICAvLyBldmVudCBpbiBhIGNvbnRlbnRlZGl0YWJsZSBmaWVsZC5cbiAgICAgICAgICAgIC8vIE1vZGlmaWVkIGZyb20gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMTA2NTk5OTAuXG4gICAgICAgICAgICB2YXIgcmFuZ2U7XG4gICAgICAgICAgICAvLyBTdGFuZGFyZHMtYmFzZWQgd2F5OyBpbXBsZW1lbnRlZCBvbmx5IGluIEZpcmVmb3hcbiAgICAgICAgICAgIGlmIChkb2N1bWVudC5jYXJldFBvc2l0aW9uRnJvbVBvaW50KSB7XG4gICAgICAgICAgICAgIHZhciBwb3MgPSBkb2N1bWVudC5jYXJldFBvc2l0aW9uRnJvbVBvaW50KHgsIHkpO1xuICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICdvZmZzZXQnOiBwb3Mub2Zmc2V0LFxuICAgICAgICAgICAgICAgICdub2RlJzogcG9zLm9mZnNldE5vZGVcbiAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuY2FyZXRSYW5nZUZyb21Qb2ludCkge1xuICAgICAgICAgICAgICAvLyBXZWJraXRcbiAgICAgICAgICAgICAgcmFuZ2UgPSBkb2N1bWVudC5jYXJldFJhbmdlRnJvbVBvaW50KHgsIHkpO1xuICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICdvZmZzZXQnOiByYW5nZS5zdGFydE9mZnNldCxcbiAgICAgICAgICAgICAgICAnbm9kZSc6IHJhbmdlLnN0YXJ0Q29udGFpbmVyXG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50LmJvZHkuY3JlYXRlVGV4dFJhbmdlKSB7XG4gICAgICAgICAgICAgIC8vIElFIGRvZXNuJ3QgbmF0aXZlbHkgc3VwcG9ydCByZXRyaWV2aW5nIHRoZSBjaGFyYWN0ZXIgb2Zmc2V0LCBzb1xuICAgICAgICAgICAgICAvLyBpbnNlcnQgaW1hZ2UgYXQgZW5kIG9mIHRleHRcbiAgICAgICAgICAgICAgLy8gVE9ETyhqcmJvdHJvcyk6IHJld3JpdGUgd2l0aCBodHRwczovL2dpdGh1Yi5jb20vdGltZG93bi9yYW5neVxuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZnVuY3Rpb24gZ2V0QWxsQ2hpbGROb2RlcyhwYXJlbnQpIHtcbiAgICAgICAgICAgIC8vIFJldHVybnMgaW4tb3JkZXIgbGlzdCBvZiBhbGwgY2hpbGQgbm9kZXMgb2YgYHBhcmVudGBcbiAgICAgICAgICAgIHZhciBiZnNTdGFjayA9IFtwYXJlbnRdO1xuICAgICAgICAgICAgdmFyIG5vZGVzID0gW107XG4gICAgICAgICAgICB3aGlsZSAoYmZzU3RhY2subGVuZ3RoKSB7XG4gICAgICAgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IGJmc1N0YWNrLnBvcCgpO1xuICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUuY2hpbGROb2Rlcykge1xuICAgICAgICAgICAgICAgIC8vIENvbmNhdCB3aXRoIGNvcHkgb2YgY2hpbGQgTm9kZUxpc3Q7IGNhbid0IHVzZSBwb3Agb3BlcmF0aW9uXG4gICAgICAgICAgICAgICAgLy8gb24gb3JpZ2luYWxcbiAgICAgICAgICAgICAgICBiZnNTdGFjayA9IGJmc1N0YWNrLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChjdXJyZW50Tm9kZS5jaGlsZE5vZGVzKSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgbm9kZXMucHVzaChjdXJyZW50Tm9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbm9kZXMucmV2ZXJzZSgpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzIyMjg5NjUwXG4gICAgICAgICAgZnVuY3Rpb24gZ2V0TGVhZk5vZGVzKHBhcmVudCkge1xuICAgICAgICAgICAgLy8gUmV0dXJucyBpbi1vcmRlciBsaXN0IG9mIGFsbCBRdWlsbCBsZWFmIG5vZGVzIG9mIGBwYXJlbnRgXG4gICAgICAgICAgICB2YXIgdGV4dE5vZGVUeXBlID0gMztcbiAgICAgICAgICAgIHZhciBub2RlcyA9IGdldEFsbENoaWxkTm9kZXMocGFyZW50KTtcbiAgICAgICAgICAgIHZhciBsZWFmTm9kZXMgPSBub2Rlcy5maWx0ZXIoZnVuY3Rpb24oZWxlbSkge1xuICAgICAgICAgICAgICByZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gdGV4dE5vZGVUeXBlIHx8ICFlbGVtLmZpcnN0Q2hpbGQ7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBsZWFmTm9kZXM7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFyIGNhcmV0UG9zaXRpb24gPSBnZXREcm9wQ2hhck9mZnNldChkcm9wRXZlbnQuY2xpZW50WCwgZHJvcEV2ZW50LmNsaWVudFkpO1xuICAgICAgICAgIGlmICghY2FyZXRQb3NpdGlvbikge1xuICAgICAgICAgICAgcmV0dXJuIHNjb3BlLmVkaXRvci5nZXRMZW5ndGgoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdmFyIGxlYXZlcyA9IGdldExlYWZOb2RlcyhlZGl0b3JDb250YWluZXIuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgncWwtZWRpdG9yJylbMF0pO1xuICAgICAgICAgIHZhciBvcEluZGV4ID0gbGVhdmVzLmluZGV4T2YoY2FyZXRQb3NpdGlvbi5ub2RlKTtcbiAgICAgICAgICB2YXIgY29udGVudHMgPSBzY29wZS5lZGl0b3IuZ2V0Q29udGVudHMoKTtcbiAgICAgICAgICBjb250ZW50cy5vcHMgPSBjb250ZW50cy5vcHMuc2xpY2UoMCwgb3BJbmRleCk7XG4gICAgICAgICAgcmV0dXJuIGNvbnRlbnRzLmxlbmd0aCgpICsgY2FyZXRQb3NpdGlvbi5vZmZzZXQ7XG4gICAgICAgIH1cblxuXG4gICAgICAgIC8vIFBvc3QgaW1hZ2UgZGF0YSB0byBhbiBBUEkgZW5kcG9pbnQgdGhhdCByZXR1cm5zIGFuIGltYWdlIFVSTCwgdGhlblxuICAgICAgICAvLyBhZGRpbmcgaXQgdG8gdGhlIGVkaXRvciAocmVwbGFjaW5nIHRoZSBnaXZlbiBjaGFyYWN0ZXIgcmFuZ2UpXG4gICAgICAgIGZ1bmN0aW9uIHVwbG9hZEltYWdlKGZpbGUsIHJhbmdlLCBlKSB7XG4gICAgICAgICAgdmFyIHVwbG9hZEFQSUVuZHBvaW50ID0gJy9vcmNoZXN0cmEvYXBpL2ludGVyZmFjZS91cGxvYWRfaW1hZ2UvJztcbiAgICAgICAgICB2YXIgc3VwcG9ydGVkVHlwZXMgPSBbJ2ltYWdlL2pwZWcnLCAnaW1hZ2UvcG5nJywgJ2ltYWdlL2dpZiddO1xuXG4gICAgICAgICAgaWYgKHN1cHBvcnRlZFR5cGVzLmluZGV4T2YoZmlsZS50eXBlKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIGFsZXJ0KCdGaWxlcyB0eXBlICcgKyBmaWxlLnR5cGUgKyAnIG5vdCBzdXBwb3J0ZWQuJyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfSBlbHNlIGlmIChlKSB7XG4gICAgICAgICAgICAvLyBDYW5jZWwgZGVmYXVsdCBicm93c2VyIGFjdGlvbiBvbmx5IGlmIGZpbGUgaXMgYWN0dWFsbHkgYW4gaW1hZ2VcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBJZiBub3RoaW5nIGlzIHNlbGVjdGVkIGluIHRoZSBlZGl0b3IsIGFwcGVuZCB0aGUgaW1hZ2UgdG8gaXRzIGVuZFxuICAgICAgICAgIGlmIChyYW5nZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgdmFyIGVuZEluZGV4ID0gc2NvcGUuZWRpdG9yLmdldExlbmd0aCgpO1xuICAgICAgICAgICAgcmFuZ2UgPSB7XG4gICAgICAgICAgICAgICdzdGFydCc6IGVuZEluZGV4LFxuICAgICAgICAgICAgICAnZW5kJzogZW5kSW5kZXhcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICAgICAgcmVhZGVyLm9ubG9hZCA9IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHZhciByYXdEYXRhID0gZS50YXJnZXQucmVzdWx0O1xuICAgICAgICAgICAgLy8gUmVtb3ZlIHByZXBlbmRlZCBpbWFnZSB0eXBlIGZyb20gZGF0YSBzdHJpbmdcbiAgICAgICAgICAgIHZhciBpbWFnZURhdGEgPSByYXdEYXRhLnN1YnN0cmluZyhyYXdEYXRhLmluZGV4T2YoXCIsXCIpICsgMSwgcmF3RGF0YS5sZW5ndGgpO1xuXG4gICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGF0YSBzaXplIG9mIGI2NC1lbmNvZGVkIHN0cmluZ1xuICAgICAgICAgICAgdmFyIGltYWdlU2l6ZSA9IGltYWdlRGF0YS5sZW5ndGggKiAzIC8gNDtcblxuICAgICAgICAgICAgaWYgKGltYWdlU2l6ZSA+IHNjb3BlLnVwbG9hZExpbWl0TWIgKiBNYXRoLnBvdygxMCwgNikpIHtcbiAgICAgICAgICAgICAgYWxlcnQoJ0ZpbGVzIGxhcmdlciB0aGFuICcgKyBzY29wZS51cGxvYWRMaW1pdE1iICsgJ01CIGNhbm5vdCBiZSB1cGxvYWRlZCcpO1xuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBQb3N0IGltYWdlIGRhdGEgdG8gQVBJOyByZXNwb25zZSBzaG91bGQgY29udGFpbiB0aGUgdXBsb2FkZWQgaW1hZ2UgdXJsXG4gICAgICAgICAgICAkaHR0cC5wb3N0KHVwbG9hZEFQSUVuZHBvaW50LCB7XG4gICAgICAgICAgICAgICAgJ2ltYWdlX2RhdGEnOiBpbWFnZURhdGEsXG4gICAgICAgICAgICAgICAgJ2ltYWdlX3R5cGUnOiBmaWxlLnR5cGUsXG4gICAgICAgICAgICAgICAgJ3ByZWZpeCc6IHNjb3BlLmltYWdlUHJlZml4XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykge1xuICAgICAgICAgICAgICAgIC8vIFJlcGxhY2Ugc2VsZWN0ZWQgcmFuZ2Ugd2l0aCBuZXcgaW1hZ2VcbiAgICAgICAgICAgICAgICBzY29wZS5lZGl0b3IuZGVsZXRlVGV4dChyYW5nZSk7XG4gICAgICAgICAgICAgICAgc2NvcGUuZWRpdG9yLmluc2VydEVtYmVkKHJhbmdlLnN0YXJ0LCAnaW1hZ2UnLCByZXNwb25zZS5kYXRhLnVybCwgJ3VzZXInKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIHRlbXBsYXRlVXJsOiAnL3N0YXRpYy9vcmNoZXN0cmEvY29tbW9uL2NvbXBvbmVudHMvcXVpbGwvcGFydGlhbHMvcXVpbGwuaHRtbCdcbiAgICB9O1xuICB9XG59KSgpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
